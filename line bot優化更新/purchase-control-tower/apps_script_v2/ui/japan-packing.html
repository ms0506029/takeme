<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬è£ç®±ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #C9915D;
            --pop-blue: #4A90E2;
            --pop-red: #FF6B6B;
            --pop-yellow: #FFE66D;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            min-height: 100vh;
            padding: 20px;
            background-color: var(--primary-color);
            background-image: radial-gradient(#fff 20%, transparent 20%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: #000;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            color: #000;
            margin-bottom: 30px;
            border: 4px solid #000;
            box-shadow: 8px 8px 0 #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin-bottom: 5px;
            font-weight: 900;
            font-size: 28px;
            color: #000;
            -webkit-text-stroke: 0.5px #000;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 4px solid #000;
            box-shadow: 6px 6px 0 #000;
        }

        .btn-primary {
            background-color: var(--pop-blue);
            border: 3px solid #000;
            color: white;
            font-weight: 600;
            transition: all 0.1s;
            box-shadow: 4px 4px 0 #000;
        }

        .btn-primary:hover {
            background-color: #357ABD;
            transform: translate(2px, 2px);
            box-shadow: 0 0 0 #000;
            color: white;
        }

        #loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            z-index: 9999;
            border: 4px solid var(--pop-yellow);
            box-shadow: 6px 6px 0 var(--pop-yellow);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <div class="header">
            <div>
                <h1><i class="fas fa-box me-3"></i>ğŸ“¦ æ—¥æœ¬è£ç®±ç®¡ç†</h1>
                <p>è¼¸å…¥æ—¥æœ¬è¨‚å–®è™Ÿï¼Œå¿«é€Ÿè£ç®±ä¸¦ç”Ÿæˆç®±è™Ÿ</p>
            </div>
            <a href="<?= appUrl ?>" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-2"></i>å›ä¸»é¸å–®
            </a>
        </div>

        <!-- ä¸»å…§å®¹å€ -->
        <div class="content-card">
            <h5 class="mb-4"><i class="fas fa-download me-2"></i>è¼‰å…¥è¨‚å–®å•†å“</h5>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">æ—¥æœ¬è¨‚å–®è™Ÿï¼š</label>
                    <input type="text" id="packingJpOrderNo" class="form-control" placeholder="è¼¸å…¥æ—¥æœ¬è¨‚å–®è™Ÿ" onkeypress="if(event.key==='Enter') loadPackingItems()">
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button onclick="loadPackingItems()" class="btn btn-primary">
                        <i class="fas fa-download me-2"></i>è¼‰å…¥å•†å“
                    </button>
                </div>
            </div>
            
            <div id="packingInfo" class="alert alert-info" style="display:none;"></div>
            
            <div id="packingItemsSection" style="display:none;">
                <hr class="my-4">
                <h5 class="mb-3"><i class="fas fa-list me-2"></i>æœªè£ç®±å•†å“æ¸…å–®</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="50px">
                                    <input type="checkbox" id="selectAllPacking" class="form-check-input">
                                </th>
                                <th>æ—¥æœ¬è¨‚å–®è™Ÿ</th>
                                <th>ESè¨‚å–®è™Ÿ</th>
                                <th>SKU</th>
                                <th>å•†å“åç¨±</th>
                                <th>é¡è‰²</th>
                                <th>å°ºå¯¸</th>
                                <th>æ•¸é‡</th>
                            </tr>
                        </thead>
                        <tbody id="packingItemsTable">
                        </tbody>
                    </table>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label class="form-label">è‡ªå®šç¾©ç®±è™Ÿï¼ˆå¿…å¡«ï¼‰ï¼š</label>
                        <input type="text" id="customBoxNumber" class="form-control" placeholder="ä¾‹å¦‚ï¼šA1, B2, æ˜“ç¢-1">
                        <small class="text-muted">è«‹è¼¸å…¥æœ‰æ„ç¾©çš„ç®±è™Ÿï¼Œæ–¹ä¾¿å°ç£æ€è²¨äººå“¡è­˜åˆ¥</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">å‚™è¨»ï¼ˆå¯é¸ï¼‰ï¼š</label>
                        <input type="text" id="packingNotes" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ˜“ç¢å“">
                    </div>
                    <div class="col-md-4 d-flex align-items-end gap-2">
                        <button onclick="createBox()" class="btn btn-success">
                            <i class="fas fa-cube me-2"></i>å®Œæˆæ­¤ç®±
                        </button>
                        <button onclick="markAllBoxesShipped()" class="btn btn-warning">
                            <i class="fas fa-shipping-fast me-2"></i>å…¨éƒ¨æ¨™è¨˜å·²å¯„å‡º
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="packingBoxesList" style="display:none;">
                <hr class="my-4">
                <h5 class="mb-3"><i class="fas fa-boxes me-2"></i>å·²è£ç®±æ¸…å–®</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>ç®±è™Ÿ</th>
                                <th>å“é …æ•¸</th>
                                <th>ç¸½æ•¸é‡</th>
                                <th>è£ç®±æ™‚é–“</th>
                                <th>å¯„å‡ºæ™‚é–“</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="packingBoxesTable">
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3 alert alert-secondary">
                    <strong><i class="fas fa-chart-pie me-2"></i>çµ±è¨ˆï¼š</strong>
                    <span id="packingStatsText"></span>
                </div>
            </div>
        </div>
    </div>

    <div id="loading">
        <div class="spinner-border spinner-border-sm me-2"></div>
        <span id="loadingText">è™•ç†ä¸­...</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPackingData = null;
        
        // ========== API èª¿ç”¨å‡½æ•¸ ==========
        function callAPI(action, data, callback) {
            google.script.run
                .withSuccessHandler(function(result) {
                    // å˜—è©¦è§£æ JSON å­—ä¸²
                    if (typeof result === 'string') {
                        try {
                            result = JSON.parse(result);
                        } catch (e) {
                            console.error('[callAPI] JSON è§£æå¤±æ•—:', e);
                            alert('è³‡æ–™è§£æéŒ¯èª¤ï¼š' + e.message);
                            return;
                        }
                    }
                    
                    if (result.success === false) {
                        alert('éŒ¯èª¤ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                        return;
                    }
                    callback(result.data || result);
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    alert('API éŒ¯èª¤ï¼š' + error.message);
                })
                .apiHandler({action: action, data: data});
        }
        
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text || 'è™•ç†ä¸­...';
            document.getElementById('loading').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        let allUnpackedItems = [];  // ç´¯ç©æ‰€æœ‰æœªè£ç®±å•†å“
        let loadedOrders = new Set();  // è¨˜éŒ„å·²è¼‰å…¥çš„è¨‚å–®è™Ÿ
        
        // ========== è£ç®±ç®¡ç†å‡½æ•¸ ==========
        
        
        function loadPackingItems() {
            const jpOrderNo = document.getElementById('packingJpOrderNo').value.trim();
            if (!jpOrderNo) {
                alert('è«‹è¼¸å…¥æ—¥æœ¬è¨‚å–®è™Ÿ');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²è¼‰å…¥
            if (loadedOrders.has(jpOrderNo)) {
                alert(`æ—¥æœ¬è¨‚å–®è™Ÿ ${jpOrderNo} å·²ç¶“è¼‰å…¥éäº†`);
                return;
            }
            
            showLoading('è¼‰å…¥ä¸­...');
            callAPI('loadItemsByJpOrder', { jpOrderNo: jpOrderNo }, function(data) {
                hideLoading();
                
                // è¨˜éŒ„å·²è¼‰å…¥çš„è¨‚å–®è™Ÿ
                loadedOrders.add(jpOrderNo);
                
                // ç´¯ç©æœªè£ç®±å•†å“
                data.unpacked.forEach(item => {
                    item.jpOrderNo = jpOrderNo;  // æ¨™è¨˜ä¾†æºè¨‚å–®è™Ÿ
                    allUnpackedItems.push(item);
                });
                
                // æ›´æ–°æ‰¹æ¬¡è³‡è¨Šé¡¯ç¤º
                updatePackingInfo();
                
                // é‡æ–°æ¸²æŸ“å•†å“åˆ—è¡¨
                renderPackingItems();
                
                // æ¸…ç©ºè¼¸å…¥æ¡†
                document.getElementById('packingJpOrderNo').value = '';
                
                alert(`âœ… å·²è¼‰å…¥æ—¥æœ¬è¨‚å–®è™Ÿ ${jpOrderNo} çš„ ${data.unpacked.length} ä»¶æœªè£ç®±å•†å“`);
            });
        }
        
        function updatePackingInfo() {
            const infoDiv = document.getElementById('packingInfo');
            infoDiv.style.display = 'block';
            
            const orderList = Array.from(loadedOrders).join(', ');
            const totalUnpacked = allUnpackedItems.length;
            
            infoDiv.innerHTML = `
                <strong>å·²è¼‰å…¥è¨‚å–®ï¼š</strong>${orderList}<br>
                <strong>æœªè£ç®±å•†å“ï¼š</strong>${totalUnpacked}ä»¶
            `;
        }
        
        function renderPackingItems() {
            const tbody = document.getElementById('packingItemsTable');
            
            if (allUnpackedItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">ç„¡æœªè£ç®±å•†å“</td></tr>';
                document.getElementById('packingItemsSection').style.display = 'block';
                return;
            }
            
            tbody.innerHTML = allUnpackedItems.map(item => `
                <tr>
                    <td><input type="checkbox" class="form-check-input packing-item-checkbox" data-row-index="${item.rowIndex}"></td>
                    <td><span class="badge bg-info">${item.jpOrderNo}</span></td>
                    <td>${item.esOrderNo}</td>
                    <td>${item.sku}</td>
                    <td>${item.productName}</td>
                    <td>${item.color || '-'}</td>
                    <td>${item.size || '-'}</td>
                    <td><strong>${item.qty}</strong></td>
                </tr>
            `).join('');
            
            document.getElementById('packingItemsSection').style.display = 'block';
            
            // è¨­å®šå…¨é¸checkbox
            document.getElementById('selectAllPacking').onclick = function() {
                const checkboxes = document.querySelectorAll('.packing-item-checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
            };
        }
        
        function createBox() {
            const notes = document.getElementById('packingNotes').value.trim();
            const customBoxNumber = document.getElementById('customBoxNumber').value.trim();
            
            // æª¢æŸ¥æ˜¯å¦è¼¸å…¥è‡ªå®šç¾©ç®±è™Ÿ
            if (!customBoxNumber) {
                alert('è«‹è¼¸å…¥è‡ªå®šç¾©ç®±è™Ÿï¼');
                document.getElementById('customBoxNumber').focus();
                return;
            }
            
            const checkboxes = document.querySelectorAll('#packingItemsTable input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å•†å“');
                return;
            }
            
            const queueRowIndexes = Array.from(checkboxes).map(cb => parseInt(cb.dataset.rowIndex));
            
            // æ‰¾å‡ºé¸ä¸­å•†å“æ¶‰åŠçš„æ‰€æœ‰è¨‚å–®è™Ÿ
            const selectedItems = allUnpackedItems.filter(item => queueRowIndexes.includes(item.rowIndex));
            const ordersInBox = [...new Set(selectedItems.map(item => item.jpOrderNo))];
            const combinedJpOrder = ordersInBox.join('+');
            
            // ä½¿ç”¨ç¬¬ä¸€å€‹è¨‚å–®è™Ÿçš„æ‰¹æ¬¡ID
            const firstItem = selectedItems[0];
            callAPI('loadItemsByJpOrder', { jpOrderNo: firstItem.jpOrderNo }, function(data) {
                showLoading('å‰µå»ºç®±å­ä¸­...');
                callAPI('createPackingBox', {
                    batchId: data.batchId,
                    jpOrderNo: combinedJpOrder,  // çµ„åˆçš„è¨‚å–®è™Ÿ
                    queueRowIndexes: queueRowIndexes,
                    notes: notes,
                    packedBy: 'Japan-User',
                    customBoxNumber: customBoxNumber  // å‚³éè‡ªå®šç¾©ç®±è™Ÿ
                }, function(boxData) {
                    hideLoading();
                    alert(`âœ… æˆåŠŸå‰µå»ºç®±è™Ÿ ${boxData.boxNumber}ï¼\nåŒ…å« ${boxData.itemCount} å€‹å“é …ï¼Œå…± ${boxData.totalQty} ä»¶\nè¨‚å–®è™Ÿï¼š${combinedJpOrder}`);
                    
                    // æ¸…ç©ºå‚™è¨»å’Œè‡ªå®šç¾©ç®±è™Ÿ
                    document.getElementById('packingNotes').value = '';
                    document.getElementById('customBoxNumber').value = '';
                    
                    // æ¸…ç©ºæ‰€æœ‰ç´¯ç©çš„å•†å“
                    allUnpackedItems = [];
                    loadedOrders.clear();
                    
                    // æ¸…ç©ºé¡¯ç¤º
                    document.getElementById('packingInfo').style.display = 'none';
                    document.getElementById('packingItemsSection').style.display = 'none';
                    document.getElementById('packingJpOrderNo').value = '';
                    
                    // é‡æ–°è¼‰å…¥ä»¥é¡¯ç¤ºç®±å­åˆ—è¡¨
                    loadPackingItems();
                });
            });
        }
        
        // The following functions (loadPackedBoxes, markBoxShipped, markAllBoxesShipped, getPackingStats)
        // are designed to work with a single batchId.
        // With the new multi-order packing, these functions would need significant re-architecture
        // to handle multiple batch IDs or a consolidated view across all loaded orders.
        // For now, they are left as-is, assuming they might be called in a context where a single batchId is relevant,
        // or will be updated in a subsequent change.
        
        function loadPackedBoxes(batchId) {
            callAPI('listBoxesByBatch', { batchId: batchId }, function(boxes) {
                const tbody = document.getElementById('packingBoxesTable');
                
                if (boxes.length === 0) {
                    document.getElementById('packingBoxesList').style.display = 'none';
                    return;
                }
                
                tbody.innerHTML = boxes.map(box => `
                    <tr>
                        <td><strong class="text-primary">${box.boxNumber}</strong></td>
                        <td>${box.itemCount}</td>
                        <td>${box.totalQty}</td>
                        <td>${formatDate(box.packedAt)}</td>
                        <td>${box.shippedAt ? formatDate(box.shippedAt) : '<span class="text-muted">-</span>'}</td>
                        <td>
                            ${!box.shippedAt ? `<button class="btn btn-sm btn-warning" onclick="markBoxShipped('${box.boxId}')">æ¨™è¨˜å·²å¯„å‡º</button>` : '<span class="badge bg-success">å·²å¯„å‡º</span>'}
                        </td>
                    </tr>
                `).join('');
                
                document.getElementById('packingBoxesList').style.display = 'block';
                
                // é¡¯ç¤ºçµ±è¨ˆ
                getPackingStats(batchId);
            });
        }
        
        function markBoxShipped(boxId) {
            if (!confirm('ç¢ºèªæ¨™è¨˜æ­¤ç®±å·²å¯„å‡ºï¼Ÿ')) return;
            
            showLoading('æ¨™è¨˜ä¸­...');
            callAPI('markBoxShipped', { boxId: boxId, shippedAt: new Date() }, function(data) {
                hideLoading();
                alert('âœ… å·²æ¨™è¨˜ç‚ºå¯„å‡º');
                loadPackingItems();
            });
        }
        
        function markAllBoxesShipped() {
            if (!currentPackingData) {
                alert('è«‹å…ˆè¼‰å…¥å•†å“');
                return;
            }
            
            if (!confirm('ç¢ºèªæ¨™è¨˜è©²æ‰¹æ¬¡æ‰€æœ‰ç®±å­å·²å¯„å‡ºï¼Ÿ')) return;
            
            showLoading('æŸ¥è©¢ä¸­...');
            callAPI('listBoxesByBatch', { batchId: currentPackingData.batchId }, function(boxes) {
                const unshippedBoxes = boxes.filter(box => !box.shippedAt);
                
                if (unshippedBoxes.length === 0) {
                    hideLoading();
                    alert('æ‰€æœ‰ç®±å­å·²æ¨™è¨˜ç‚ºå¯„å‡º');
                    return;
                }
                
                let completed = 0;
                showLoading(`æ¨™è¨˜ä¸­... (0/${unshippedBoxes.length})`);
                
                unshippedBoxes.forEach(box => {
                    callAPI('markBoxShipped', { boxId: box.boxId, shippedAt: new Date() }, function() {
                        completed++;
                        if (completed === unshippedBoxes.length) {
                            hideLoading();
                            alert(`âœ… å·²æ¨™è¨˜ ${completed} å€‹ç®±å­ç‚ºå¯„å‡º`);
                            loadPackingItems();
                        } else {
                            document.getElementById('loadingText').textContent = `æ¨™è¨˜ä¸­... (${completed}/${unshippedBoxes.length})`;
                        }
                    });
                });
            });
        }
        
        function getPackingStats(batchId) {
            callAPI('getPackingStats', { batchId: batchId }, function(stats) {
                const statsText = document.getElementById('packingStatsText');
                statsText.innerHTML = `
                    ç¸½ç®±æ•¸ï¼š<strong>${stats.totalBoxes}</strong> | 
                    ç¸½å“é …ï¼š<strong>${stats.totalItems}</strong> | 
                    ç¸½æ•¸é‡ï¼š<strong>${stats.totalQty}</strong> | 
                    å·²å¯„å‡ºï¼š<strong class="text-success">${stats.shippedBoxes}</strong> | 
                    å¾…å¯„å‡ºï¼š<strong class="text-warning">${stats.pendingShip}</strong>
                `;
            });
        }
        
        // æ—¥æœŸæ ¼å¼åŒ–
        function formatDate(date) {
            if (!date) return '-';
            const d = new Date(date);
            return d.toLocaleString('zh-TW', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
