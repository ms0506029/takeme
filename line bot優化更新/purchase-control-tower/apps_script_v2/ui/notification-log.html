<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥ç´€éŒ„æŸ¥è©¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
        :root {
            --primary-color: #C9915D;
            --pop-blue: #4A90E2;
            --pop-red: #FF6B6B;
            --pop-yellow: #FFE66D;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            min-height: 100vh;
            padding: 20px;
            background-color: var(--primary-color);
            background-image: radial-gradient(#fff 20%, transparent 20%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: #000;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            color: #000;
            margin-bottom: 30px;
            border: 4px solid #000;
            box-shadow: 8px 8px 0 #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin-bottom: 5px;
            font-weight: 900;
            font-size: 28px;
            color: #000;
            -webkit-text-stroke: 0.5px #000;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 4px solid #000;
            box-shadow: 6px 6px 0 #000;
        }

        .btn-primary {
            background-color: var(--pop-blue);
            border: 3px solid #000;
            color: white;
            font-weight: 600;
            transition: all 0.1s;
            box-shadow: 4px 4px 0 #000;
        }

        .btn-primary:hover {
            background-color: #357ABD;
            transform: translate(2px, 2px);
            box-shadow: 0 0 0 #000;
            color: white;
        }

        #loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            z-index: 9999;
            border: 4px solid var(--pop-yellow);
            box-shadow: 6px 6px 0 var(--pop-yellow);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1><i class="fas fa-history me-2"></i>é€šçŸ¥ç´€éŒ„æŸ¥è©¢</h1>
                <p>æŸ¥çœ‹ LINE æ¨æ’­ç´€éŒ„ã€è¿½è¹¤é€šçŸ¥ç‹€æ…‹</p>
            </div>
            <a href="<?= appUrl ?>" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>å›ä¸»é¸å–®
            </a>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-number text-primary" id="totalCount">-</div>
                    <div class="stat-label">ç¸½é€šçŸ¥æ•¸</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-number text-success" id="successCount">-</div>
                    <div class="stat-label">æˆåŠŸ</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-number text-danger" id="failedCount">-</div>
                    <div class="stat-label">å¤±æ•—</div>
                </div>
            </div>
        </div>
        
        <div class="content-card">
            <h3><i class="fas fa-filter me-2"></i>ç¯©é¸æ¢ä»¶</h3>
            
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label">è¨‚å–®ç·¨è™Ÿï¼š</label>
                    <input type="text" id="filterOrderNo" class="form-control" placeholder="ä¾‹å¦‚ï¼šES5336">
                </div>
                <div class="col-md-3">
                    <label class="form-label">ç‹€æ…‹ï¼š</label>
                    <select id="filterStatus" class="form-select">
                        <option value="">å…¨éƒ¨</option>
                        <option value="success">æˆåŠŸ</option>
                        <option value="failed">å¤±æ•—</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">è¨Šæ¯é¡å‹ï¼š</label>
                    <select id="filterMessageType" class="form-select">
                        <option value="">å…¨éƒ¨</option>
                        <option value="JP_TO_TW_SHIPPED">æ—¥æœ¬â†’å°ç£å·²å‡ºè²¨</option>
                        <option value="TW_ARRIVED">å·²æŠµé”å°ç£</option>
                        <option value="TW_TO_CUSTOMER_SHIPPED">å°ç£å·²å‡ºè²¨</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">é¡¯ç¤ºç­†æ•¸ï¼š</label>
                    <select id="filterLimit" class="form-select">
                        <option value="50">50 ç­†</option>
                        <option value="100" selected>100 ç­†</option>
                        <option value="200">200 ç­†</option>
                    </select>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button onclick="queryLogs()" class="btn btn-primary">
                    <i class="fas fa-search me-2"></i>æŸ¥è©¢
                </button>
                <button onclick="refreshStats()" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt me-2"></i>æ›´æ–°çµ±è¨ˆ
                </button>
            </div>
        </div>
        
        <div id="logsContainer" class="content-card" style="display: none;">
            <h3><i class="fas fa-list me-2"></i>æŸ¥è©¢çµæœ</h3>
            <p id="logsSummary" class="text-muted mb-3"></p>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th width="180">æ™‚é–“</th>
                            <th>è¨‚å–®ç·¨è™Ÿ</th>
                            <th>LINE User ID</th>
                            <th>è¿½è¹¤ç¢¼</th>
                            <th>è¨Šæ¯é¡å‹</th>
                            <th>è¨Šæ¯é è¦½</th>
                            <th width="100">ç‹€æ…‹</th>
                            <th>éŒ¯èª¤è¨Šæ¯</th>
                        </tr>
                    </thead>
                    <tbody id="logsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        function queryLogs() {
            const filters = {
                orderNo: document.getElementById('filterOrderNo').value.trim(),
                status: document.getElementById('filterStatus').value,
                messageType: document.getElementById('filterMessageType').value
            };
            
            const limit = parseInt(document.getElementById('filterLimit').value);
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        displayLogs(result.data);
                    } else {
                        alert('æŸ¥è©¢å¤±æ•—ï¼š' + result.error);
                    }
                })
                .withFailureHandler(handleError)
                .apiQueryNotificationLogs(filters, limit);
        }
        
        function displayLogs(data) {
            document.getElementById('logsContainer').style.display = 'block';
            
            const summary = document.getElementById('logsSummary');
            summary.innerHTML = `å…± <strong>${data.length}</strong> ç­†ç´€éŒ„`;
            
            const tbody = document.getElementById('logsBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</td></tr>';
                return;
            }
            
            data.forEach(log => {
                const row = document.createElement('tr');
                const statusBadge = log.status === 'success' 
                    ? '<span class="badge bg-success">æˆåŠŸ</span>' 
                    : '<span class="badge bg-danger">å¤±æ•—</span>';
                
                row.innerHTML = `
                    <td><small class="text-muted">${formatTimestamp(log.timestamp)}</small></td>
                    <td>${log.esOrderNo || '-'}</td>
                    <td><small class="text-muted" title="${log.lineUserId}">${log.lineUserId ? log.lineUserId.substring(0, 10) + '...' : '-'}</small></td>
                    <td>${log.trackingJPtoTW || '-'}</td>
                    <td><small>${formatMessageType(log.messageType)}</small></td>
                    <td class="message-preview" title="${log.messageContentShort}">${log.messageContentShort || '-'}</td>
                    <td>${statusBadge}</td>
                    <td><small class="text-danger">${log.errorMessage || '-'}</small></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function refreshStats() {
            // æŸ¥è©¢å…¨éƒ¨è³‡æ–™ä¾†è¨ˆç®—çµ±è¨ˆ
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        updateStats(result.data);
                    }
                })
                .withFailureHandler(handleError)
                .apiQueryNotificationLogs({}, 1000);
        }
        
        function updateStats(data) {
            const total = data.length;
            const success = data.filter(log => log.status === 'success').length;
            const failed = data.filter(log => log.status === 'failed').length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('successCount').textContent = success;
            document.getElementById('failedCount').textContent = failed;
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-TW');
        }
        
        function formatMessageType(type) {
            const types = {
                'JP_TO_TW_SHIPPED': 'ğŸš¢ æ—¥æœ¬â†’å°ç£',
                'TW_ARRIVED': 'âœˆï¸ æŠµé”å°ç£',
                'TW_TO_CUSTOMER_SHIPPED': 'ğŸ“® å°ç£å‡ºè²¨'
            };
            return types[type] || type;
        }
        
        function handleError(error) {
            console.error(error);
            alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
        }
        
        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.onload = function() {
            queryLogs();
            refreshStats();
        };
    </script>
</body>
</html>
