<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£æ€è²¨æŸ¥è©¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #C9915D;
            --pop-blue: #4A90E2;
            --pop-red: #FF6B6B;
            --pop-yellow: #FFE66D;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            min-height: 100vh;
            padding: 20px;
            background-color: var(--primary-color);
            background-image: radial-gradient(#fff 20%, transparent 20%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: #000;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            color: #000;
            margin-bottom: 30px;
            border: 4px solid #000;
            box-shadow: 8px 8px 0 #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin-bottom: 5px;
            font-weight: 900;
            font-size: 28px;
            color: #000;
            -webkit-text-stroke: 0.5px #000;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 4px solid #000;
            box-shadow: 6px 6px 0 #000;
        }

        .btn-primary {
            background-color: var(--pop-blue);
            border: 3px solid #000;
            color: white;
            font-weight: 600;
            transition: all 0.1s;
            box-shadow: 4px 4px 0 #000;
        }

        .btn-primary:hover {
            background-color: #357ABD;
            transform: translate(2px, 2px);
            box-shadow: 0 0 0 #000;
            color: white;
        }

        .btn-outline-light {
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #000;
            color: #000;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.1s;
            box-shadow: 4px 4px 0 #000;
            text-decoration: none;
            display: inline-block;
        }

        .btn-outline-light:hover {
            background: #fff;
            transform: translate(2px, 2px);
            box-shadow: 0 0 0 #000;
            color: #000;
        }

        #loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            z-index: 9999;
            border: 4px solid var(--pop-yellow);
            box-shadow: 6px 6px 0 var(--pop-yellow);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <div class="header">
            <div>
                <h1><i class="fas fa-clipboard-check me-3"></i>ğŸ“‹ å°ç£æ€è²¨æŸ¥è©¢ <span class="badge bg-secondary fs-6">v2.0</span></h1>
                <p>è¼¸å…¥ç®±è™ŸæŸ¥è©¢å…§å®¹ç‰©ï¼Œæ¨™è¨˜æ€è²¨å®Œæˆ</p>
            </div>
            <a href="<?= appUrl ?>" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-2"></i>å›ä¸»é¸å–®
            </a>
        </div>

        <!-- ä¸»å…§å®¹å€ -->
        <div class="content-card">
            <h5 class="mb-4"><i class="fas fa-search me-2"></i>æŸ¥è©¢ç®±å…§å®¹ç‰©</h5>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">ç®±è™Ÿï¼š</label>
                    <input type="number" id="pickingBoxId" class="form-control" placeholder="è¼¸å…¥ç®±è™Ÿï¼ˆä¾‹å¦‚ï¼š1, 2, 3...ï¼‰" min="1" onkeypress="if(event.key==='Enter') loadBoxContents()">
                    <small class="text-muted">è¼¸å…¥ç°¡å–®æ•¸å­—å³å¯ï¼Œä¾‹å¦‚ï¼š1</small>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button onclick="loadBoxContents()" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>æŸ¥è©¢
                    </button>
                </div>
            </div>
        </div>
        
        <!-- çµæœå€ -->
        <div id="pickingResult" class="content-card" style="display:none;">
            <div class="alert alert-success">
                <div class="row">
                    <div class="col-md-4">
                        <strong><i class="fas fa-box me-2"></i>ç®±è™Ÿï¼š</strong><span id="resultBoxId" class="ms-2"></span>
                    </div>
                    <div class="col-md-4">
                        <strong><i class="fas fa-barcode me-2"></i>æ—¥æœ¬è¨‚å–®è™Ÿï¼š</strong><span id="resultJpOrder" class="ms-2"></span>
                    </div>
                    <div class="col-md-4">
                        <strong><i class="fas fa-cubes me-2"></i>ç¸½ä»¶æ•¸ï¼š</strong><span id="resultTotalQty" class="ms-2"></span>ä»¶
                    </div>
                </div>
            </div>
            
            <!-- å‚™è¨»å€ - é¡¯çœ¼ä½ç½® -->
            <div id="notesSection" class="alert alert-warning border-warning mb-3" style="display:none; border-left: 5px solid #ffc107;">
                <div class="d-flex align-items-start">
                    <div class="me-3">
                        <i class="fas fa-sticky-note fa-2x text-warning"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading mb-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>é‡è¦å‚™è¨»
                        </h5>
                        <p id="resultNotes" class="mb-0 fs-5 fw-bold" style="white-space: pre-wrap;"></p>
                    </div>
                </div>
            </div>
            
            <h5 class="mb-3"><i class="fas fa-list-ul me-2"></i>ç®±å…§å•†å“æ˜ç´°</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>åºè™Ÿ</th>
                            <th>ESè¨‚å–®è™Ÿ</th>
                            <th>SKU</th>
                            <th>å•†å“åç¨±</th>
                            <th>è¦æ ¼</th>
                            <th>æ•¸é‡</th>
                        </tr>
                    </thead>
                    <tbody id="pickingItemsTable">
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 p-3 border rounded bg-light">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <button onclick="markPickingComplete()" class="btn btn-success btn-lg">
                            <i class="fas fa-check-double me-2"></i>æ¨™è¨˜æ€è²¨å®Œæˆ
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted">
                            <div><strong><i class="fas fa-clock me-2"></i>æ€è²¨å®Œæˆæ™‚é–“ï¼š</strong><span id="resultPickedAt" class="ms-2">-</span></div>
                            <div class="mt-1"><strong><i class="fas fa-user me-2"></i>æ€è²¨äººï¼š</strong><span id="resultPickedBy" class="ms-2">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading">
        <div class="spinner-border spinner-border-sm me-2"></div>
        <span id="loadingText">è™•ç†ä¸­...</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentBoxData = null;
        
        // ========== API èª¿ç”¨å‡½æ•¸ ==========
        function callAPI(action, data, callback) {
            console.log('[callAPI] é–‹å§‹èª¿ç”¨:', action, 'åƒæ•¸:', data);
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('[callAPI] API Response åŸå§‹æ•¸æ“š:', result);
                    console.log('[callAPI] Response é¡å‹:', typeof result);
                    console.log('[callAPI] Response æ˜¯å¦ç‚º null:', result === null);
                    console.log('[callAPI] Response æ˜¯å¦ç‚º undefined:', result === undefined);
                    
                    // å˜—è©¦è§£æ JSON å­—ä¸² (å¦‚æœå¾Œç«¯è¿”å›çš„æ˜¯å­—ä¸²)
                    if (typeof result === 'string') {
                        try {
                            console.log('[callAPI] æ”¶åˆ°å­—ä¸²ï¼Œå˜—è©¦è§£æ JSON');
                            result = JSON.parse(result);
                            console.log('[callAPI] è§£æå¾Œçš„æ•¸æ“š:', result);
                        } catch (e) {
                            console.error('[callAPI] JSON è§£æå¤±æ•—:', e);
                        }
                    }

                    // è™•ç†å„ç¨®å¯èƒ½çš„è¿”å›æ ¼å¼
                    if (!result) {
                        console.error('[callAPI] éŒ¯èª¤ï¼šresult ç‚º falsy å€¼');
                        alert('éŒ¯èª¤ï¼šä¼ºæœå™¨ç„¡å›æ‡‰');
                        hideLoading();
                        return;
                    }
                    
                    console.log('[callAPI] result æœ‰ success å±¬æ€§:', result.hasOwnProperty('success'));
                    
                    // å¦‚æœæœ‰ success å±¬æ€§
                    if (result.hasOwnProperty('success')) {
                        console.log('[callAPI] result.success =', result.success);
                        if (result.success === false) {
                            console.error('[callAPI] API è¿”å›å¤±æ•—:', result.error);
                            alert('éŒ¯èª¤ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                            hideLoading();
                            return;
                        }
                        // æˆåŠŸï¼šæå– dataï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦å‰‡ä½¿ç”¨æ•´å€‹ result
                        console.log('[callAPI] result.data =', result.data);
                        console.log('[callAPI] result.data é¡å‹:', typeof result.data);
                        if (result.data) {
                            console.log('[callAPI] èª¿ç”¨ callbackï¼Œå‚³å…¥ result.data');
                            callback(result.data);
                        } else {
                            // data ä¸å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ resultï¼ˆå»é™¤ success å±¬æ€§ï¼‰
                            console.log('[callAPI] æ²’æœ‰ data å±¬æ€§ï¼Œç›´æ¥ä½¿ç”¨ result');
                            callback(result);
                        }
                    } else {
                        // æ²’æœ‰ success å±¬æ€§ï¼Œç›´æ¥ä½¿ç”¨çµæœ
                        console.log('[callAPI] æ²’æœ‰ success å±¬æ€§ï¼Œç›´æ¥ä½¿ç”¨ result');
                        callback(result);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    console.error('API éŒ¯èª¤:', error);
                    alert('API éŒ¯èª¤ï¼š' + error.message);
                })
                .apiHandler({action: action, data: data});
        }
        
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text || 'è™•ç†ä¸­...';
            document.getElementById('loading').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // ========== æ€è²¨æŸ¥è©¢å‡½æ•¸ ==========
        
        function loadBoxContents() {
            const boxId = document.getElementById('pickingBoxId').value.trim();
            
            if (!boxId) {
                alert('è«‹è¼¸å…¥ç®±è™Ÿ');
                return;
            }
            
            showLoading('æŸ¥è©¢ä¸­...');
            callAPI('getBoxContents', { boxNumber: boxId }, function(result) {
                hideLoading();
                
                console.log('Box Contents:', result);
                
                if (!result || !result.boxId) {
                    alert('æŸ¥è©¢å¤±æ•—ï¼šç„¡æ³•å–å¾—ç®±å­è³‡æ–™');
                    return;
                }
                
                currentBoxData = result;
                
                // é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
                document.getElementById('resultBoxId').textContent = result.boxId;
                document.getElementById('resultJpOrder').textContent = result.jpOrderNo;
                document.getElementById('resultTotalQty').textContent = result.totalQty;
                
                // é¡¯ç¤ºå‚™è¨»ï¼ˆå¦‚æœæœ‰ï¼‰
                const notesSection = document.getElementById('notesSection');
                const notesText = document.getElementById('resultNotes');
                if (result.notes && result.notes.trim()) {
                    notesText.textContent = result.notes;
                    notesSection.style.display = 'block';
                } else {
                    notesSection.style.display = 'none';
                }
                
                // é¡¯ç¤ºæ€è²¨ç‹€æ…‹
                document.getElementById('resultPickedAt').textContent = result.pickedAt ? formatDate(result.pickedAt) : '-';
                document.getElementById('resultPickedBy').textContent = result.pickedBy || '-';
                
                // é¡¯ç¤ºå•†å“æ˜ç´°
                const tbody = document.getElementById('pickingItemsTable');
                tbody.innerHTML = result.items.map((item, index) => {
                    const spec = [item.color, item.size].filter(Boolean).join(' / ');
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.esOrderNo}</td>
                            <td><code>${item.sku}</code></td>
                            <td>${item.productName}</td>
                            <td>${spec || '-'}</td>
                            <td><strong>${item.qty}</strong></td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('pickingResult').style.display = 'block';
                
                // æ»¾å‹•åˆ°çµæœå€
                document.getElementById('pickingResult').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }
        
        function markPickingComplete() {
            if (!currentBoxData) {
                alert('è«‹å…ˆæŸ¥è©¢ç®±è™Ÿ');
                return;
            }
            
            if (currentBoxData.pickedAt) {
                alert('âš ï¸ æ­¤ç®±å·²æ–¼ ' + formatDate(currentBoxData.pickedAt) + ' æ¨™è¨˜ç‚ºæ€è²¨å®Œæˆ');
                return;
            }
            
            if (!confirm('âœ… ç¢ºèªæ¨™è¨˜æ€è²¨å®Œæˆï¼Ÿ')) return;
            
            showLoading('æ¨™è¨˜ä¸­...');
            callAPI('markBoxPicked', {
                boxId: currentBoxData.boxId,
                pickedBy: 'Taiwan-User'
                // ç§»é™¤ pickedAt åƒæ•¸ï¼Œè®“å¾Œç«¯è‡ªå‹•ç”Ÿæˆæ™‚é–“æˆ³
            }, function(result) {
                hideLoading();
                alert('âœ… å·²æ¨™è¨˜ç‚ºæ€è²¨å®Œæˆ');
                
                // æ›´æ–°é¡¯ç¤º
                document.getElementById('resultPickedAt').textContent = formatDate(result.pickedAt);
                document.getElementById('resultPickedBy').textContent = 'Taiwan-User';
                
                currentBoxData.pickedAt = result.pickedAt;
                currentBoxData.pickedBy = 'Taiwan-User';
            });
        }
        
        // æ—¥æœŸæ ¼å¼åŒ–
        function formatDate(date) {
            if (!date) return '-';
            const d = new Date(date);
            return d.toLocaleString('zh-TW', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // æ”¯æ´EnteréµæŸ¥è©¢
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Taiwan Picking UI v2.0 Loaded');
            const boxInput = document.getElementById('pickingBoxId');
            if (boxInput) {
                boxInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') loadBoxContents();
                });
            } else {
                console.error('æ‰¾ä¸åˆ° pickingBoxId å…ƒç´ ');
            }
        });
    </script>
</body>
</html>
