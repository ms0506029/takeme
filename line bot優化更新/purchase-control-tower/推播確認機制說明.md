# 推播確認機制使用說明

## 🔔 功能說明

系統已實作「確認欄位模式（B模式）」的推播機制，確保每次 LINE 推播都經過您的確認。

---

## ⭐ 新增欄位：ReadyToNotify

### 欄位位置
- **工作表**：Queue
- **欄位**：W 欄（第 23 欄）
- **名稱**：ReadyToNotify
- **資料類型**：布林值（TRUE/FALSE）

### 欄位用途
- **TRUE**：準備發送 LINE 通知，系統會自動推播
- **FALSE**：不發送通知（預設值）

---

## 📋 使用流程

### 方法 1：手動勾選模式（最安全）

1. **編輯 Queue 表資料**：
   - 填寫商品資訊
   - 填寫追蹤碼（`Tracking_JP_to_TW`）
   - 更新採購狀態（`Purchase_Status`）

2. **確認資料無誤後**：
   - 將 `ReadyToNotify` 欄位勾選為 TRUE
   - （可使用下拉選單或直接輸入 TRUE）

3. **系統自動處理**：
   - 偵測到 `ReadyToNotify = TRUE`
   - 自動推播 LINE 通知給客戶
   - 推播成功後自動重設為 FALSE
   - 紀錄到 `NotificationsLog`

### 方法 2：通知管理介面（推薦）

1. **開啟通知管理頁面**：
   - 點選主選單的「🔔 通知管理」卡片
   - 或直接訪問：`?page=notification-manager`

2. **查看待發送通知**：
   - 系統自動顯示所有 `ReadyToNotify = TRUE` 的項目
   - 顯示訂單編號、商品、追蹤碼、LINE User ID

3. **預覽訊息內容**：
   - 每個通知卡片都會顯示「訊息預覽」
   - 包含完整的 LINE 訊息文字
   - 包含物流查詢連結

4. **確認發送**：
   - 單筆確認：點選「✅ 確認發送」
   - 批次確認：點選「✅ 批次確認所有待發送」
   - 跳過通知：點選「⏭️ 跳過」（將重設 ReadyToNotify）

---

## 🎯 實際操作範例

### 範例 1：單一訂單通知

**場景**：訂單 ES5336 的商品已從日本寄出

**操作步驟**：

1. 開啟 Google Sheets → Queue 表
2. 找到訂單 ES5336 的商品行
3. 填入追蹤碼：`S: Tracking_JP_to_TW = 1234567890`
4. 更新狀態：`I: Purchase_Status = 已寄出回台灣`
5. **確認發送**：勾選 `W: ReadyToNotify = TRUE`
6. 等待 3-5 秒，系統自動推播
7. 檢查 `W: ReadyToNotify` 是否自動變回 FALSE（表示已發送）

### 範例 2：使用通知管理介面

**場景**：批次處理多個訂單的出貨通知

**操作步驟**：

1. 在 Queue 表中準備好所有訂單資料
2. 填入所有追蹤碼
3. 將這些訂單的 `ReadyToNotify` 統一勾選為 TRUE
4. 開啟 Web App → 點選「🔔 通知管理」
5. 查看所有待發送通知（應該顯示剛才勾選的訂單）
6. **預覽每個訊息內容**（確認無誤）
7. 點選「✅ 批次確認所有待發送」
8. 系統自動發送所有通知並顯示結果

---

## ⚙️ 進階設定

### 如何恢復自動推播模式？

如果您未來熟悉系統後，想要恢復自動推播（不需要手動確認），可以：

1. 開啟 `Triggers.gs` 檔案
2. 找到標記 `🔴 以下為舊的自動觸發邏輯` 的區塊
3. 取消註解（移除 `/*` 和 `*/`）
4. 註解掉新的確認邏輯（加上 `/*` 和 `*/`）
5. 儲存並重新部署

**注意**：恢復自動模式後，編輯追蹤碼或狀態就會立即推播，無確認步驟。

---

## 🛡️ 防呆機制

### 1. 防重複推播
- 已推播過的訂單（`Notify_Pushed_Flag = TRUE`）不會再次推播
- 即使再次勾選 `ReadyToNotify`，系統也會跳過

### 2. LINE User ID 檢查
- 如果 `OrderLineUserMap` 中找不到對應的 LINE User ID
- 系統會記錄錯誤到 `NotificationsLog`
- 在通知管理介面會顯示「❌ 未找到」警告
- 無法點選「確認發送」按鈕

### 3. 必要欄位檢查
- 如果缺少追蹤碼，訊息預覽會顯示警告
- 建議先填完所有資料再勾選 `ReadyToNotify`

---

## 📊 通知管理介面功能

### 顯示內容

每個待發送通知會顯示：
- 📌 訂單編號（醒目標記）
- 📦 商品名稱
- 🔖 SKU
- 📍 採購狀態  
- 🚚 追蹤碼
- 👤 LINE User ID（或警告訊息）
- 📱 **訊息預覽**（完整的 LINE 訊息文字）

### 操作按鈕

- **✅ 確認發送**：發送單一通知
- **⏭️ 跳過**：取消本次發送（重設 ReadyToNotify）
- **✅ 批次確認所有待發送**：一次發送所有通知

---

## 📝 注意事項

1. **測試建議**：
   - 先用自己的 LINE User ID 測試
   - 確認訊息內容正確再批次發送

2. **時機選擇**：
   - 建議在確認所有資料無誤後，統一勾選 `ReadyToNotify`
   - 避免邊編輯邊勾選，可能導致資訊不完整

3. **錯誤處理**：
   - 如果發送失敗，檢查 `NotificationsLog` 的錯誤訊息
   - 常見錯誤：LINE User ID 不存在、Token 過期

4. **批次操作提示**：
   - 批次發送前，系統會顯示確認對話框
   - 顯示將發送的數量
   - 發送完成後顯示成功與失敗數量

---

## 🎓 最佳實踐

### 建議工作流程

1. **準備階段**：
   - 在 Queue 表填寫所有訂單資料
   - 填寫追蹤碼
   - 更新採購狀態
   - **不要勾選** `ReadyToNotify`

2. **確認階段**：
   - 檢查所有資料正確性
   - 確認追蹤碼無誤
   - 確認 `OrderLineUserMap` 中有對應的 LINE User ID

3. **批次勾選**：
   - 統一勾選所有要發送的訂單
   - 將 `ReadyToNotify` 設為 TRUE

4. **管理介面確認**：
   - 開啟「通知管理」頁面
   - 預覽所有訊息內容
   - 使用批次確認發送

5. **驗證階段**：
   - 檢查客戶是否收到通知
   - 查看 `NotificationsLog` 確認發送狀態
   - 確認 `ReadyToNotify` 已自動重設為 FALSE

---

## ✅ 總結

**確認欄位模式的優點**：
- ✅ 安全：避免誤發通知
- ✅ 可控：可以預覽訊息內容
- ✅ 批次：支援批次確認發送
- ✅ 紀錄：完整的發送紀錄

**適用場景**：
- 初次使用系統
- 需要仔細確認每個通知
- 批次處理大量訂單
- 團隊協作需要審核機制

祝您使用順利！🎉
