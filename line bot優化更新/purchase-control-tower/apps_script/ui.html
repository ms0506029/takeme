<!doctype html>
<meta charset="utf-8">
<script>
// ====== åŸºç¤å·¥å…· ======
const EXEC_BASE = '<?= ScriptApp.getService().getUrl(); ?>';
function qs(id){ return document.getElementById(id); }
function msg(s){ qs('msg').innerHTML = s; }
function busyOn(text){ const el=qs('busy'); el.style.display='inline-block'; el.textContent=text||'è™•ç†ä¸­â€¦'; }
function busyOff(){ const el=qs('busy'); el.style.display='none'; }
function int(v){ v=parseFloat(v); return isNaN(v)?0:v; }
function floor(v){ return Math.floor(v); }
async function api(path){
  const url = EXEC_BASE + (path.startsWith('?')? path : ('?'+path));
  // ä¸å¸¶ credentialsï¼Œé¿å…è·¨ç¶²åŸŸè½‰å€æ™‚è¢« CORS æ””ä¸‹ï¼ˆApps Script å›æ‡‰ç‚º *ï¼‰
  const r = await fetch(url);
  const ct = r.headers.get('content-type')||'';
  if(!ct.includes('application/json')){
    // ä»¥æ–‡å­—å›å‚³éŒ¯èª¤ï¼Œæ–¹ä¾¿é™¤éŒ¯
    const t = await r.text();
    return {ok:false, error:'é JSON å›æ‡‰', text:t};
  }
  return await r.json();
}

// ====== è¼‰å…¥ ======
window.addEventListener('load', refresh);
window.addEventListener('load', function(){
  var el = document.getElementById('docDate');
  if(el && !el.value){
    var d = new Date();
    var yyyy = d.getFullYear();
    var mm = String(d.getMonth()+1).padStart(2,'0');
    var dd = String(d.getDate()).padStart(2,'0');
    el.value = yyyy + '-' + mm + '-' + dd;
  }
});

// çµ±è¨ˆ + å·²è³¼æœªå›å¯«
async function refresh(){
  busyOn('è¼‰å…¥ä¸­â€¦');
  let j = await api('?action=listQueue');
  if(!j.ok && /å°šæœªè¨­å®šè©¦ç®—è¡¨ ID/.test(j.error||'')){
    // è‡ªå‹•åˆå§‹åŒ–ä¸¦ç¶å®š
    await api('?action=initSheets');
    j = await api('?action=listQueue');
  }
  if(!j.ok){ msg('è¼‰å…¥å¤±æ•—ï¼š'+j.error); return; }
  const d=j.data;
  qs('stats').innerHTML = '<b>çµ±è¨ˆ</b><div class="row">'
    + '<span class="tag">å¾…è³¼ '+d.counts.pending+'</span>'
    + '<span class="tag">é–å®š '+d.counts.locked+'</span>'
    + '<span class="tag">å·²è³¼ '+d.counts.done+'</span>'
    + '<span class="tag">å·²è³¼æœªå›å¯« '+d.counts.toWrite+'</span>'
    + '</div>';
  renderToWrite(d.toWriteRows||[]);
  await loadCandidates();
  await loadBatches();
  busyOff();
}

function renderToWrite(rows){
  var body=(rows||[]).map(function(x){
    return '<tr>'
      + '<td>'+(x['ESè¨‚å–®è™Ÿ']||'')+'</td>'
      + '<td>'+(x['ERPéŠ·è²¨å–®è™Ÿ']||'')+'</td>'
      + '<td>'+(x['SKU']||'')+'</td>'
      + '<td>'+(x['é¡è‰²']||'')+'</td>'
      + '<td>'+(x['å°ºå¯¸']||'')+'</td>'
      + '<td>'+(x['æ•¸é‡']||'')+'</td>'
      + '<td>'+(x['æ¡è³¼å‚™è¨»']||'')+'</td>'
      + '</tr>';
  }).join('');
  qs('list').innerHTML = '<table><thead><tr>'
    + '<th>ESè¨‚å–®</th><th>ERPå–®</th><th>SKU</th><th>è‰²</th><th>å°º</th><th>æ•¸</th><th>å‚™è¨»</th>'
    + '</tr></thead><tbody>'+body+'</tbody></table>';
}

// åŒ¯å‡ºæ‘˜è¦ CSV
async function exportCsv(){
  busyOn('ç”¢ç”Ÿ CSVâ€¦');
  const j = await api('?action=exportEcountCsv');
  if(!j.ok){ msg('åŒ¯å‡ºå¤±æ•—ï¼š'+j.error); return; }
  var a=j.data;
  var html='å·²ç”¢ç”Ÿï¼š<a target="_blank" href="'+a.memo.url+'">'+a.memo.name+'</a>';
  if(a.status){ html+='ã€<a target="_blank" href="'+a.status.url+'">'+a.status.name+'</a>'; }
  msg(html);
  refresh();
  busyOff();
}

// åŒ¯å…¥ï¼ˆDrive æª”æ¡ˆIDï¼‰
async function importEs(){
  var id=qs('fileId').value.trim();
  if(!id){ qs('importMsg').innerText='è«‹è²¼ä¸Š Drive æª”æ¡ˆ ID'; return; }
  busyOn('åŒ¯å…¥ä¸­â€¦');
  let j=await api('?action=importEsXlsx&fileId='+encodeURIComponent(id));
  if(!j.ok && /å°šæœªè¨­å®šè©¦ç®—è¡¨ ID/.test(j.error||'')){
    await api('?action=initSheets');
    j=await api('?action=importEsXlsx&fileId='+encodeURIComponent(id));
  }
  if(!j.ok){ qs('importMsg').innerText='åŒ¯å…¥å¤±æ•—ï¼š'+j.error; return; }
  qs('importMsg').innerText='å·²åŒ¯å…¥ '+j.data.inserted+' ç­†ï¼ˆProductsï¼‰';
  refresh();
  busyOff();
}

// åŒ¯å…¥ï¼ˆæœ¬æ©Ÿä¸Šå‚³ï¼‰
function importEsLocal(){
  var f=qs('esFile').files[0];
  if(!f){ qs('importMsg').innerText='è«‹é¸æ“‡ Excel æª”ï¼ˆ.xlsxï¼‰'; return; }
  var reader=new FileReader();
  reader.onload=function(ev){
    var dataUrl=ev.target.result||'';
    var b64 = (dataUrl.indexOf(',')>=0 ? dataUrl.split(',')[1] : dataUrl);
    if(!(window.google && google.script && google.script.run)){
      qs('importMsg').innerText='æ­¤åŠŸèƒ½éœ€åœ¨ GAS ç¶²é ä¸­é–‹å•Ÿï¼ˆHtmlServiceï¼‰';
      return;
    }
    qs('importMsg').innerText='ä¸Šå‚³ä¸­...';
    busyOn('ä¸Šå‚³ä¸­â€¦');
    google.script.run
      .withSuccessHandler(function(res){
        if(res && res.ok){
          qs('importMsg').innerText='å·²åŒ¯å…¥ '+((res.data && res.data.inserted)||0)+' ç­†ï¼ˆæœ¬æ©Ÿä¸Šå‚³ï¼‰';
          refresh();
        }else{
          qs('importMsg').innerText='åŒ¯å…¥å¤±æ•—ï¼š'+(res && res.error);
        }
        busyOff();
      })
      .withFailureHandler(function(err){ qs('importMsg').innerText='åŒ¯å…¥å¤±æ•—ï¼š'+err; busyOff(); })
      .importEsXlsxUploaded(f.name, b64);
  };
  reader.readAsDataURL(f);
}

// å¾…è™•ç†æ¸…å–®
function picked(){ return Array.prototype.slice.call(document.querySelectorAll('.pick:checked')).map(function(el){ return el.value; }).join(','); }
function recalc(){
  var rate=int(qs('rate').value), shipping=int(qs('shipping').value);
  var picks=Array.prototype.slice.call(document.querySelectorAll('.pick:checked')).map(function(cb){ return parseInt(cb.value,10); });
  var sumJpy=0;
  picks.forEach(function(r){
    var price=int((document.querySelector('.price[data-row="'+r+'"]').value)||'0');
    var tr=document.querySelector('.pick[value="'+r+'"]').closest('tr');
    var qty=int((tr && tr.querySelectorAll('td')[6] && tr.querySelectorAll('td')[6].textContent) || '1');
    sumJpy += price*qty;
  });
  var totalJpy=sumJpy+shipping, totalTwd=rate? floor(totalJpy*rate):0;
  qs('sum').innerText='åˆè¨ˆï¼šå•†å“åˆè¨ˆ JPY '+sumJpy+' + é‹è²» JPY '+shipping+' = JPY '+totalJpy+'ï¼›TWD(ç„¡æ¢ä»¶æ¨å») '+totalTwd;
}

async function loadCandidates(){
  const j=await api('?action=listCandidates');
  if(!j.ok) return;
  var rows=(j.data.rows||[]).map(function(x){
    var price=x['æ¡è³¼å–®åƒ¹JPY']||'';
    var cols=[
      '<input type="checkbox" class="pick" value="'+x.rowIndex+'"/>',
      x['ESè¨‚å–®è™Ÿ']||'', x['SKU']||'', x['å“å']||'', x['é¡è‰²']||'', x['å°ºå¯¸']||'', x['æ•¸é‡']||'',
      '<input type="number" class="price" data-row="'+x.rowIndex+'" value="'+price+'" style="width:100px"/>',
      x['æ¡è³¼ç‹€æ…‹']||'', x['æ¡è³¼æ‰¹æ¬¡ID']||''
    ];
    return '<tr>'+cols.map(function(v){ return '<td>'+v+'</td>'; }).join('')+'</tr>';
  }).join('');
  qs('candidates').innerHTML = '<table><thead><tr><th><input type="checkbox" id="pickAll"/></th><th>ESè¨‚å–®</th><th>SKU</th><th>å“å</th><th>è‰²</th><th>å°º</th><th>æ•¸</th><th>å–®åƒ¹JPY</th><th>ç‹€æ…‹</th><th>æ‰¹æ¬¡</th></tr></thead><tbody>' + rows + '</tbody></table>';
  var a=qs('pickAll');
  if(a){ a.addEventListener('change', function(){ Array.prototype.forEach.call(document.querySelectorAll('.pick'), function(cb){ cb.checked=a.checked; }); }); }
  Array.prototype.forEach.call(document.querySelectorAll('.price'), function(el){ el.addEventListener('input', recalc); });
  Array.prototype.forEach.call(document.querySelectorAll('.pick'), function(el){ el.addEventListener('change', recalc); });
  qs('rate').addEventListener('input', recalc);
  qs('shipping').addEventListener('input', recalc);
  recalc();
}

// æ¨™è¨˜
async function updateSel(op, extra){
  var rows=picked();
  if(!rows){ msg('è«‹å…ˆå‹¾é¸åˆ—'); return; }
  var url='?action=updateSelection&op='+op+'&rows='+encodeURIComponent(rows);
  if(extra){ url+=extra; }
  busyOn('æ›´æ–°ä¸­â€¦');
  const j=await api(url);
  if(!j.ok){ msg('æ›´æ–°å¤±æ•—ï¼š'+j.error); return; }
  if(j.data && j.data.batchId){ msg('å·²æ¨™è¨˜ '+j.data.updated+' ç­†ï¼Œæ‰¹æ¬¡ '+j.data.batchId); }
  else { msg('å·²æ›´æ–° '+j.data.updated+' ç­†'); }
  refresh();
  busyOff();
}
function markPurchasedNewBatch(){
  var sup=qs('supplier').value, jp=qs('jpOrder').value.trim();
  var order=picked().split(',').map(function(s){ return parseInt(s,10); }).filter(Boolean);
  var priceMap=order.map(function(r){ var el=document.querySelector('.price[data-row="'+r+'"]'); return (el && el.value)? el.value:'0'; }).join(',');
  var rate=qs('rate').value||'', shipping=qs('shipping').value||'';
  var extra='&supplier='+encodeURIComponent(sup)+'&jpOrder='+encodeURIComponent(jp)+'&prices='+encodeURIComponent(priceMap)+'&rate='+encodeURIComponent(rate)+'&shipping='+encodeURIComponent(shipping);
  updateSel('purchaseNewBatch', extra);
}
function markPurchasedOnly(){
  var order=picked().split(',').map(function(s){ return parseInt(s,10); }).filter(Boolean);
  if(!order.length){ msg('è«‹å…ˆå‹¾é¸åˆ—'); return; }
  var priceMap=order.map(function(r){ var el=document.querySelector('.price[data-row="'+r+'"]'); return (el && el.value)? el.value:'0'; }).join(',');
  var extra='&prices='+encodeURIComponent(priceMap);
  updateSel('markPurchasedOnly', extra);
}
function markOOS(){ updateSel('markOOS'); }
function markPreorder(){
  var rows=picked(); if(!rows){ msg('è«‹å…ˆå‹¾é¸åˆ—'); return; }
  var ymRaw=qs('preYm').value.trim();
  if(!ymRaw){ msg('è«‹è¼¸å…¥é è³¼æœˆä»½'); return; }
  var ym=ymRaw;
  if(/^[0-9]{1,2}$/.test(ymRaw)){
    var year=new Date().getFullYear();
    ym=year + '-' + ymRaw.padStart(2,'0');
  } else if(/^[0-9]{4}$/.test(ymRaw)){
    ym=ymRaw + '-01';
  }
  if(!/^[0-9]{4}-[0-9]{2}$/.test(ym)){ msg('è«‹è¼¸å…¥é è³¼æœˆä»½ï¼ˆæ ¼å¼ YYYY-MMï¼Œä¾‹å¦‚ 2025-11ï¼‰'); return; }
  qs('preYm').value = ym; // å›å¡«æ¨™æº–æ ¼å¼
  var xu=qs('preXun').value;
  var extra='&preYm='+encodeURIComponent(ym)+'&preXun='+encodeURIComponent(xu);
  updateSel('markPreorder', extra);
}

// æ‰¹æ¬¡æ¸…å–®/ä¸‹è¼‰
async function loadBatches(){
  const j=await api('?action=listBatches');
  if(!j.ok) return;
  var rows=(j.data.rows||[]).map(function(b){
    var a='<a href="#" onclick="downloadBatchPo(\''+b.id+'\')">ä¸‹è¼‰</a>';
    return '<tr><td>'+b.created+'</td><td>'+b.id+'</td><td>'+b.supplier+'</td><td>'+(b.rate||'')+'</td><td>'+(b.shipping||'')+'</td><td>'+b.count+'</td><td>'+a+'</td></tr>';
  }).join('');
  qs('batchList').innerHTML = '<table><thead><tr><th>å»ºç«‹æ™‚é–“</th><th>æ‰¹æ¬¡ID</th><th>ä¾›æ‡‰å•†</th><th>åŒ¯ç‡</th><th>é‹è²»JPY</th><th>ç­†æ•¸</th><th>æ“ä½œ</th></tr></thead><tbody>'+rows+'</tbody></table>';
}
function downloadBatchByInput(){
  var id=qs('batchIdInput').value.trim();
  if(!id){ msg('è«‹è¼¸å…¥æ‰¹æ¬¡ID'); return; }
  downloadBatchPo(id);
}

// ä¸‹è¼‰ã€æ‰¹æ¬¡ ECOUNT æ¡è³¼å–®ã€Excelï¼ˆèˆ‡ã€Œä¸‹è¼‰é¸å– ECOUNT æ¡è³¼å–® Excelã€ä¸€è‡´ï¼‰
function downloadBatchPo(id){
  busyOn('ç”¢ç”Ÿ Excelâ€¦');
  api('?action=exportBatchEcountPo&batchId='+encodeURIComponent(id))
    .then(function(j){
      if(!j.ok){ msg('ä¸‹è¼‰å¤±æ•—ï¼š'+j.error); return; }
      var f=j.data.file; msg('å·²ç”¢ç”Ÿï¼š<a target="_blank" href="'+f.url+'">'+f.name+'</a>');
      window.open(f.url,'_blank');
    })
    .catch(function(err){ msg('ä¸‹è¼‰å¤±æ•—ï¼š'+err); })
    .finally(function(){ busyOff(); });
}

function downloadSelectedItems(){
  var rows=picked(); if(!rows){ msg('è«‹å…ˆå‹¾é¸åˆ—'); return; }
  var sup=qs('supplier').value; var shipping=qs('shipping').value||'';
  busyOn('ç”¢ç”Ÿ CSVâ€¦');
  api('?action=exportSelectedItemsCsv&rows='+encodeURIComponent(rows)+'&supplier='+encodeURIComponent(sup)+'&shipping='+encodeURIComponent(shipping))
    .then(function(j){
      if(!j.ok){ msg('ä¸‹è¼‰å¤±æ•—ï¼š'+j.error); return; }
      var f=j.data.file; msg('å·²ç”¢ç”Ÿï¼š<a target="_blank" href="'+f.url+'">'+f.name+'</a>');
      window.open(f.url,'_blank');
    })
    .catch(function(err){ msg('ä¸‹è¼‰å¤±æ•—ï¼š'+err); })
    .finally(function(){ busyOff(); });
}

function downloadSelectedEcountPo(){
  var rows=picked(); if(!rows){ msg('è«‹å…ˆå‹¾é¸åˆ—'); return; }
  var sup=qs('supplier').value; var jp=qs('jpOrder').value||''; var rate=qs('rate').value||''; var shipping=qs('shipping').value||'';
  // å‚³éå‹¾é¸åˆ—å°æ‡‰çš„å–®åƒ¹ï¼ˆå³ä¾¿æœªå…ˆæ¨™è¨˜ï¼Œä¹Ÿèƒ½ç”¨ UI å–®åƒ¹ï¼‰
  var order=rows.split(',').map(function(s){ return parseInt(s,10); }).filter(Boolean);
  var priceMap=order.map(function(r){ var el=document.querySelector('.price[data-row="'+r+'"]'); return (el && el.value)? el.value:'0'; }).join(',');
  var doc = (document.getElementById('docDate')||{}).value || '';
  var docYmd = doc ? doc.replace(/-/g,'') : '';
  busyOn('ç”¢ç”Ÿ Excelâ€¦');
  api('?action=exportSelectedEcountPoCsv'
      +'&rows='+encodeURIComponent(rows)
      +'&supplier='+encodeURIComponent(sup)
      +'&jpOrder='+encodeURIComponent(jp)
      +'&rate='+encodeURIComponent(rate)
      +'&shipping='+encodeURIComponent(shipping)
      +'&prices='+encodeURIComponent(priceMap)
      +'&docDate='+encodeURIComponent(docYmd)
      +'&format=xlsx')
    .then(function(j){
      if(!j.ok){ msg('ä¸‹è¼‰å¤±æ•—ï¼š'+j.error); return; }
      var f=j.data.file; msg('å·²ç”¢ç”Ÿï¼š<a target="_blank" href="'+f.url+'">'+f.name+'</a>');
      window.open(f.url,'_blank');
    })
    .catch(function(err){ msg('ä¸‹è¼‰å¤±æ•—ï¼š'+err); })
    .finally(function(){ busyOff(); });
}

// å…¨åŸŸæ›è¼‰ï¼ˆé¿å… onclick æ‰¾ä¸åˆ°ï¼‰
window.importEsLocal=importEsLocal;
window.importEs=importEs;
window.markPurchasedNewBatch=markPurchasedNewBatch;
window.markOOS=markOOS;
window.markPreorder=markPreorder;
window.downloadBatchByInput=downloadBatchByInput;
window.downloadBatchPo=downloadBatchPo;
window.downloadSelectedEcountPo=downloadSelectedEcountPo;
</script>
<style>
  body{font-family:-apple-system,Segoe UI,Roboto,Arial; padding:20px; line-height:1.6}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  button{padding:8px 14px;border-radius:10px;border:1px solid #ddd;cursor:pointer;background:#fff}
  .card{border:1px solid #eee;border-radius:14px;padding:14px;margin-top:14px}
  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px solid #f0f0f0;padding:6px 8px;font-size:13px}
  .tag{padding:2px 8px;border-radius:999px;background:#f3f4f6;font-size:12px}
</style>

<h2>æ¡è³¼æ§åˆ¶å¡” PROï¼ˆSafari ç‰ˆï¼‰</h2>
<div class="row">
  <button onclick="exportCsv()">â¬ ç”¢ç”Ÿ ECOUNT åŒ¯å…¥ CSVï¼ˆæ‘˜è¦ï¼‰</button>
  <button onclick="refresh()">ğŸ”„ é‡æ–°æ•´ç†</button>
  <span id="busy" style="display:none;margin-left:8px;padding:2px 8px;background:#eef;border:1px solid #99f;border-radius:6px;color:#334">è™•ç†ä¸­â€¦</span>
  <span id="msg"></span>
  </div>

<div class="card">
  <h3>åŒ¯å…¥ EasyStore Excel</h3>
  <div class="row">
    <input id="fileId" placeholder="è²¼ä¸Š Drive æª”æ¡ˆ IDï¼ˆ.xlsxï¼‰" style="min-width:360px;padding:6px 8px"/>
    <button onclick="importEs()">ğŸ“¥ ç”± Drive æª”æ¡ˆID åŒ¯å…¥</button>
    <span style="color:#888">æˆ–</span>
    <input type="file" id="esFile" accept=".xlsx,.xls"/>
    <button onclick="importEsLocal()">ğŸ“¤ ä¸Šå‚³æœ¬æ©Ÿ Excel åŒ¯å…¥</button>
    <small>é€£çµä¾‹ï¼šhttps://drive.google.com/file/d/é€™æ®µå°±æ˜¯æª”æ¡ˆID/view</small>
  </div>
  <div id="importMsg"></div>
</div>

<div id="stats" class="card"></div>

<div class="card">
  <h3>å¾…è™•ç†æ¸…å–®ï¼ˆå‹¾é¸å¾Œæ¨™è¨˜ï¼‰</h3>
  <div class="row" style="gap:8px;margin-bottom:8px">
    <label>ä¾›æ‡‰å•† <select id="supplier"><option value="freak-j">freak-j</option><option value="zozo-h">zozo-h</option></select></label>
    <input id="jpOrder" placeholder="æ—¥æœ¬è¨‚å–®è™Ÿï¼ˆé¸å¡«ï¼‰"/>
    <label>åŒ¯ç‡ <input id="rate" placeholder="ä¾‹ï¼š0.21" style="width:100px"/></label>
    <label>å–®æ“šæ—¥æœŸ <input id="docDate" type="date" style="width:160px"/></label>
    <label>é‹è²»JPY <input id="shipping" placeholder="0" style="width:120px"/></label>
    <button onclick="markPurchasedOnly()">âœ… åªæ¨™è¨˜å·²è³¼ï¼ˆä¸å»ºæ‰¹æ¬¡ï¼‰</button>
    <button onclick="markPurchasedNewBatch()">âœ… æ¨™è¨˜å·²è³¼ï¼ˆå»ºç«‹æ–°æ‰¹æ¬¡ï¼‰</button>
    <button onclick="downloadSelectedItems()">â¬‡ï¸ ä¸‹è¼‰é¸å– items CSV</button>
    <button onclick="downloadSelectedEcountPo()">â¬‡ï¸ ä¸‹è¼‰é¸å– ECOUNT æ¡è³¼å–® Excel</button>
    <button onclick="markOOS()">â›” æ¨™è¨˜ç¼ºè²¨</button>
    <label>é è³¼æœˆä»½ <input id="preYm" placeholder="YYYY-MM" style="width:120px"/></label>
    <label>æ—¬ <select id="preXun"><option>ä¸Š</option><option>ä¸­</option><option>ä¸‹</option></select></label>
    <button onclick="markPreorder()">ğŸ—“ï¸ æ¨™è¨˜é è³¼</button>
  </div>
  <div id="candidates"></div>
  <div id="sum" style="margin-top:8px;color:#555"></div>
</div>

<div class="card">
  <h3>æ‰¹æ¬¡ä¸‹è¼‰</h3>
  <div class="row" style="gap:8px;margin-bottom:8px">
    <input id="batchIdInput" placeholder="è¼¸å…¥æ‰¹æ¬¡ID ä¾‹ï¼šfreak-j-20251022-123045" style="min-width:320px"/>
    <button onclick="downloadBatchByInput()">â¬‡ï¸ ä¸‹è¼‰è©²æ‰¹æ¬¡ æ¡è³¼å–® Excel</button>
  </div>
  <div id="batchList"></div>
  </div>

<div class="card">
  <h3>å·²è³¼ä½†æœªå›å¯« ERP</h3>
  <div id="list"></div>
</div>
