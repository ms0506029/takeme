# 採購控制塔系統 - 完整安裝與測試指南

## 🎉 系統完成狀態

**✅ 100% 完成！**

所有功能已全部實作完成，包含：
- ✅ 後端服務層（13 個 GAS 檔案）
- ✅ 前端 UI 頁面（7 個 HTML 頁面）
- ✅ Google Sheets 自動初始化
- ✅ 完整文檔

---

## 📁 檔案清單總覽

### Google Apps Script 後端
```
apps_script_v2/
├── appsscript.json           # GAS 設定檔
├── Config.gs                 # 設定與常數
├── InitSheets.gs             # Sheets 初始化
├── Code.gs                   # 主入口
├── API.gs                    # API 整合
├── Triggers.gs               # onEdit 觸發器
└── services/
    ├── ConfigService.gs      # 設定管理
    ├── QueueService.gs       # Queue 操作
    ├── LineService.gs        # LINE 推播
    ├── NotificationService.gs# 通知紀錄
    ├── ShipmentService.gs    # 箱號管理
    ├── DiscountService.gs    # 折扣分攤
    ├── BatchService.gs       # 批次管理
    └── OrderMatcherService.gs# 訂單比對
```

### 前端 UI
```
ui/
├── index.html               # 主選單
├── procurement-summary.html # 採購彙總
├── batch-management.html    # 批次管理
├── shipment-management.html # 箱號管理
├── picking-view.html        # 揀貨視圖
├── order-matcher-v2.html    # 訂單比對 v2
├── notification-log.html    # 通知紀錄查詢
└── styles.html              # 共用樣式
```

---

## 🚀 安裝步驟（20 分鐘完成）

### 步驟 1：建立 Google Sheets（2 分鐘）

1. 開啟 [Google Drive](https://drive.google.com)
2. 點選「新增」→「Google 試算表」
3. 命名為「採購控制塔系統」
4. **記下 Spreadsheet ID**（網址列中的 ID）

### 步驟 2：開啟 Apps Script（1 分鐘）

1. 在 Google Sheets 中，點選「擴充功能」→「Apps Script」
2. 刪除預設的 Code.gs 內容

### 步驟 3：複製所有程式碼（10 分鐘）

**重要**：請按照以下順序建立檔案：

#### 3.1 建立主要檔案

| 順序 | 檔案名稱 | 位置 |
|-----|---------|------|
| 1 | Config.gs | 根目錄 |
| 2 | InitSheets.gs | 根目錄 |
| 3 | Code.gs | 根目錄 |
| 4 | API.gs | 根目錄 |
| 5 | Triggers.gs | 根目錄 |

**操作方式**：
- 點選「+」→「指令碼」
- 輸入檔案名稱（例如：`Config`）
- 複製對應的 `.gs` 檔案內容並貼上
- 儲存（Ctrl+S）

#### 3.2 建立服務層檔案

| 順序 | 檔案名稱 | 位置 |
|-----|---------|------|
| 6 | services/ConfigService | 根目錄 |
| 7 | services/QueueService | 根目錄 |
| 8 | services/LineService | 根目錄 |
| 9 | services/NotificationService | 根目錄 |
| 10 | services/ShipmentService | 根目錄 |
| 11 | services/DiscountService | 根目錄 |
| 12 | services/BatchService | 根目錄 |
| 13 | services/OrderMatcherService | 根目錄 |

> **注意**：GAS 不支援資料夾結構，所有 `.gs` 檔案都會顯示在根目錄

#### 3.3 建立 HTML 前端檔案

| 順序 | 檔案名稱 | 類型 |
|-----|---------|------|
| 14 | ui/styles | HTML |
| 15 | ui/index | HTML |
| 16 | ui/procurement-summary | HTML |
| 17 | ui/batch-management | HTML |
| 18 | ui/shipment-management | HTML |
| 19 | ui/picking-view | HTML |
| 20 | ui/order-matcher-v2 | HTML |
| 21 | ui/notification-log | HTML |
| 22 | ui/notification-manager | HTML |

**操作方式**：
- 點選「+」→「HTML」
- 輸入檔案名稱（例如：`ui/index`）
- 複製對應的 HTML 檔案內容並貼上
- 儲存

### 步驟 4：執行初始化（3 分鐘）

1. 在 Apps Script 編輯器中，找到 `InitSheets.gs`
2. 在函式下拉選單中選擇 `initializeAllSheets`
3. 點選「執行」按鈕（▶️）
4. **第一次執行需要授權**：
   - 點選「查看權限」
   - 選擇您的 Google 帳號
   - 點選「前往採購控制塔系統（不安全）」
   - 點選「允許」
5. 等待執行完成（約 10-20 秒）
6. 回到 Google Sheets，確認所有工作表已建立：
   - ✅ Queue
   - ✅ OrderLineUserMap
   - ✅ ShipmentsHeader
   - ✅ ShipmentsDetail
   - ✅ NotificationsLog
   - ✅ DiscountTemplates

### 步驟 5：設定 Script Properties（2 分鐘）

1. 在 Apps Script 編輯器左側，點選「專案設定」（齒輪圖示）
2. 捲動到「指令碼屬性」區塊
3. 點選「新增指令碼屬性」
4. 新增以下屬性：

| 屬性名稱 | 值 | 說明 |
|---------|---|------|
| `LINE_CHANNEL_ACCESS_TOKEN` | 您的 LINE Token | 從 LINE Developers Console 取得 |
| `TRACKING_URL_BASE` | https://example.com/tracking | 您的物流查詢頁 URL（可選） |

> **注意**：`SPREADSHEET_ID` 已在步驟 4 自動設定，無需手動新增

### 步驟 6：部署 Web App（2 分鐘）

1. 在 Apps Script 編輯器右上角，點選「部署」→「新增部署作業」
2. 點選「選取類型」→「網頁應用程式」
3. 填寫設定：
   - **說明**：採購控制塔 v1.0
   - **執行身分**：我
   - **具有存取權的使用者**：任何人
4. 點選「部署」
5. **授權（如果需要）**：
   - 點選「授權存取權」
   - 選擇您的帳號
   - 允許權限
6. **複製 Web App URL**（重要！）
7. 點選「完成」

### 步驟 7：安裝 onEdit 觸發器（1 分鐘）

1. 在 Apps Script 編輯器左側，點選「觸發條件」（時鐘圖示）
2. 點選右下角「新增觸發條件」
3. 設定：
   - **選擇要執行的函式**：onEdit
   - **選擇活動來源**：來自試算表
   - **選擇事件類型**：編輯時
4. 點選「儲存」

---

## ✅ 測試流程

### 測試 1：Google Sheets 初始化（1 分鐘）

1. 確認 Google Sheets 中有以下工作表：
   - ✅ Queue（**24 個欄位**）⭐ 已更新
   - ✅ OrderLineUserMap（4 個欄位）
   - ✅ ShipmentsHeader（7 個欄位）
   - ✅ ShipmentsDetail（8 個欄位）
   - ✅ NotificationsLog（9 個欄位）
   - ✅ DiscountTemplates（3 個欄位，已包含預設模板）

2. **重要**：檢查 Queue 表的新欄位：
   - ✅ W 欄（ReadyToNotify）- 推播確認欄位
   - ✅ X 欄（Courier）- 物流公司選擇
   - ✅ L 欄（ExpectedShipLabel）- 公式欄

3. 檢查 Queue 表的 L 欄（ExpectedShipLabel）是否有公式

### 測試 2：Web App 主選單（2 分鐘）

1. 開啟步驟 6 取得的 Web App URL
2. 應該看到漂亮的主選單頁面
3. 包含 **7 個功能卡片**：
   - 🔔 **通知管理**（新功能⭐）
   - 📊 採購彙總
   - 📦 批次管理
   - 🚢 箱號管理
   - ✅ 揀貨視圖
   - 🔍 訂單比對 v2
   - 📱 通知紀錄查詢

4. 點選任一功能，確認頁面可以正常載入

### 測試 3：自動通知流程（3 分鐘）

**重要**：這是系統最核心的功能

1. **準備測試資料**：
   
   在 `OrderLineUserMap` 表中新增一筆：
   ```
   ES_Order_No    LINE_User_ID              Customer_Name
   TEST001        U1234567890abcdefghij     測試客戶
   ```
   > 請將 `LINE_User_ID` 改為您自己的 LINE User ID

2. **在 Queue 表中新增測試訂單**：
   ```
   QueueID  ES_Order_No  Product_Name  SKU        Purchase_Status
   Q001     TEST001      測試商品      TEST-SKU   待購買
   ```

3. **觸發自動通知**：
   - 將 `Purchase_Status` 改為「已寄出回台灣」
   - 在 `Tracking_JP_to_TW` 欄位填入：`1234567890`

4. **檢查結果**：
   - 等待 5-10 秒
   - 您的 LINE 應該會收到通知訊息
   - 檢查 `NotificationsLog` 是否有新紀錄
   - 檢查 Queue 表的 `Notify_Pushed_Flag` 是否變為 TRUE

5. **如果沒收到通知**：
   - 檢查 Apps Script 執行記錄（檢視 → 執行作業）
   - 檢查 `LINE_CHANNEL_ACCESS_TOKEN` 是否正確
   - 檢查 LINE User ID 是否正確

### 測試 4：採購彙總功能（5 分鐘）

1. **準備測試資料**：
   
   在 Queue 表中新增幾筆相同商品但不同訂單：
   ```
   QueueID  ES_Order_No  Product_Name  SKU      Color  Size  Qty_Ordered  ListPrice
   Q002     TEST002      T恤          SHIRT01  白色   M     2            1000
   Q003     TEST003      T恤          SHIRT01  白色   M     1            1000
   Q004     TEST004      T恤          SHIRT01  白色   M     3            1000
   ```

2. **開啟採購彙總頁面**：
   - 點選主選單的「📊 採購彙總」
   - 應該看到彙總結果：SKU=SHIRT01, 總數量=6, 訂單數=3

3. **測試一鍵勾選**：
   - 點選「勾選相關行」按鈕
   - 確認提示訊息
   - 回到 Queue 表，檢查這 3 行的 `SelectedForBatch` 是否變為 TRUE

4. **測試單價套用**：
   - 在單價輸入框輸入：900
   - 點選「套用單價」
   - 回到 Queue 表，檢查這 3 行的 `ActualPurchasePrice` 是否變為 900

5. **測試折扣分攤**：
   - 勾選剛才的品項
   - 點選「💰 折扣分攤工具」
   - 輸入實付金額：5000（原價 6000）
   - 點選「計算折扣分攤」
   - 應該看到計算結果（折扣比例約 83.33%）
   - 點選「確認套用到 Queue」
   - 回到 Queue 表確認單價已更新

### 測試 5：批次管理與匯出（3 分鐘）

1. **建立批次**：
   - 開啟「📦 批次管理」
   - 在「批次名稱」輸入：2025-01-測試批次
   - 點選「✅ 建立新批次」
   - 應該顯示成功訊息與批次 ID

2. **查看批次內容**：
   - 輸入剛才建立的批次 ID
   - 點選「🔍 查看」
   - 應該看到包含的品項列表

3. **匯出批次**：
   - 輸入批次 ID
   - 點選「📥 匯出為 CSV」
   - 應該看到 CSV 資料
   - **重點檢查「摘要」欄位**：應顯示類似 `TEST002x2, TEST003x1, TEST004x3`
   - 點選「💾 下載 CSV 檔案」測試下載

### 測試 6：箱號管理與揀貨（3 分鐘）

1. **建立箱號**：
   - 開啟「🚢 箱號管理」
   - 填寫資料：
     - 追蹤碼：TEST123456
     - 出貨日期：今天
     - 狀態：已出發
     - Queue 列索引：2,3,4（剛才測試用的行號）
   - 點選「✅ 建立箱號」
   - 記下箱號 ID

2. **查詢箱號**：
   - 在下方輸入剛才的箱號 ID
   - 點選「🔍 查詢」
   - 應該看到箱號基本資訊與箱內商品明細
   - **重點檢查「訂單摘要」欄位**

3. **揀貨視圖**：
   - 開啟「✅ 揀貨視圖」
   - 輸入箱號 ID
   - 點選「🔍 查詢揀貨清單」
   - 應該看到彙總後的商品卡片
   - 點選「✓ 標記已清點」測試互動

### 測試 7：推播確認機制與物流公司選擇（5 分鐘）⭐ 新功能

**重要**：這是最新新增的功能

1. **在 Queue 表準備資料**：
   ```
   QueueID  ES_Order_No  Product_Name  SKU       Tracking_JP_to_TW  ReadyToNotify  Courier
   Q005     TEST005      測試商品      TEST-002  SF1234567890       FALSE          SF
   ```

2. **開啟通知管理頁面**：
   - 點選主選單的「🔔 通知管理」
   - 此時應該沒有待發送通知（因為 ReadyToNotify = FALSE）

3. **勾選 ReadyToNotify**：
   - 回到 Queue 表
   - 將 `W 欄（ReadyToNotify）` 改為 TRUE

4. **再次開啟通知管理**：
   - 應該看到剛才的訂單出現在待發送清單
   - 檢查物流公司選擇器（應該已選擇「順豐速運」）
   - **查看訊息預覽**：
     - 應顯示「物流公司：順豐速運」
     - 查詢連結應為順豐的 URL 格式

5. **測試物流公司切換**：
   - 在下拉選單改選「Score 物流」
   - 點選「更新」按鈕
   - 訊息預覽應即時更新為 Score 的 URL

6. **確認發送**：
   - 點選「✅ 確認發送」
   - 檢查您的 LINE 是否收到通知
   - 確認通知內容包含正確的物流公司與查詢連結

7. **驗證自動重設**：
   - 回到 Queue 表
   - 檢查 `ReadyToNotify` 是否已自動變回 FALSE
   - 檢查 `Notify_Pushed_Flag` 是否變為 TRUE

---

## 🎯 功能完整性確認

請確認以下所有功能都可正常運作：

### 核心功能
- ✅ Google Sheets 自動建立（6 個工作表）
- ✅ onEdit 自動觸發器
- ✅ **推播確認機制**（ReadyToNotify 欄位）⭐ 新增
- ✅ **物流公司選擇**（SF 順豐 / SCORE）⭐ 新增
- ✅ LINE 推播通知（含物流查詢連結）
- ✅ 通知紀錄寫入
- ✅ 通知管理介面（預覽訊息、批次確認）⭐ 新增

### 採購管理
- ✅ 採購彙總（依 SKU+Color+Size 分組）
- ✅ 一鍵勾選所有相關 Queue 行
- ✅ 批次套用單價
- ✅ 折扣分攤計算（依金額比例）

### 批次與箱號
- ✅ 建立批次（共用 SelectedForBatch）
- ✅ 批次匯出（含訂單摘要欄位）
- ✅ 箱號管理（建箱、查詢）
- ✅ 揀貨視圖（彙總顯示、訂單摘要）

### 訂單比對
- ✅ 多訂單搜尋（支援多條件）
- ✅ 到貨自動分配（依時間優先）
- ✅ 分配預覽與確認

### 通知紀錄
- ✅ 查詢通知紀錄（支援篩選）
- ✅ 統計資訊顯示

---

## 🔧 常見問題與解決

### Q1: 執行 initializeAllSheets 時出現「找不到 QUEUE_COLS」錯誤

**原因**：Config.gs 尚未載入

**解決**：
1. 確認 Config.gs 檔案已建立並儲存
2. 重新整理 Apps Script 編輯器
3. 再次執行 initializeAllSheets

### Q2: Web App 無法開啟，顯示錯誤

**可能原因**：
1. 部署時選錯「執行身分」
2. HTML 檔案名稱錯誤

**解決**：
1. 重新部署，確保選擇「執行身分：我」
2. 檢查所有 HTML 檔案名稱是否正確（例如 `ui/index`）

### Q3: LINE 通知沒有發送

**檢查清單**：
1. ✅ LINE_CHANNEL_ACCESS_TOKEN 是否正確設定
2. ✅ OrderLineUserMap 中 LINE_User_ID 是否正確
3. ✅ onEdit 觸發器是否已安裝
4. ✅ 檢查 Apps Script 執行記錄（檢視 → 執行作業）
5. ✅ 檢查 NotificationsLog 的錯誤訊息

### Q4: 採購彙總頁面顯示「暫無資料」

**原因**：Queue 表中沒有資料

**解決**：
1. 在 Queue 表中新增測試資料
2. 點選「🔄 重新載入」

### Q5: 批次匯出的摘要欄位沒有顯示訂單編號

**原因**：可能是資料格式問題

**解決**：
1. 確認 Queue 表的 `ES_Order_No` 欄位有值
2. 確認 BatchService.exportBatch 函數正常執行
3. 檢查 Apps Script 執行記錄

### Q6: 修改追蹤碼後沒有自動推播 ⭐ 新增

**原因**：系統已改為確認模式，需要手動勾選 ReadyToNotify

**解決**：
1. 確認 Queue 表的 `ReadyToNotify` 欄位（W 欄）
2. 將 ReadyToNotify 設為 TRUE 才會觸發推播
3. 或使用「通知管理」頁面預覽後確認發送

**說明**：這是安全機制，避免誤發通知。詳見 `推播確認機制說明.md`

### Q7: 如何選擇物流公司？ ⭐ 新增

**方法 1**：在 Queue 表直接填寫
- 在 `X 欄（Courier）` 填入：
  - `SF` - 順豐速運
  - `SCORE` - Score 物流

**方法 2**：在通知管理介面選擇（推薦）
- 開啟「通知管理」頁面
- 使用下拉選單選擇物流公司
- 訊息預覽會即時更新對應的查詢連結

**說明**：不同物流公司會生成不同的查詢 URL。詳見 `物流公司選擇功能說明.md`

---

## 📊 系統架構說明

```
┌─────────────────────────────┐
│   Google Sheets (資料庫)    │
│  - Queue (採購控制中心)     │
│  - OrderLineUserMap         │
│  - Shipments                │
│  - NotificationsLog         │
└──────────────┬──────────────┘
               │
┌──────────────▼──────────────┐
│ Google Apps Script (後端)  │
│  - Services (服務層)        │
│  - API (前端介面)           │
│  - Triggers (自動化)        │
└──────────────┬──────────────┘
               │
        ┌──────┴──────┐
        │             │
┌───────▼──────┐  ┌──▼───────┐
│  Web App UI  │  │ LINE Bot │
│  (前端頁面)  │  │  (推播)  │
└──────────────┘  └──────────┘
```

---

## 🎓 使用建議

### 1. 初次使用流程

1. **建立訂單與 LINE 對照表**：
   - 在 OrderLineUserMap 中建立訂單與客戶的對照

2. **新增採購商品**：
   - 在 Queue 表中新增需要採購的商品行

3. **採購彙總與分攤**：
   - 使用「採購彙總」統整相同品項
   - 使用「折扣分攤工具」計算實際單價

4. **建立批次並匯出**：
   - 勾選要採購的品項
   - 建立批次
   - 匯出採購單（含訂單摘要）

5. **建立箱號**：
   - 商品到日本後，建立箱號
   - 綁定對應的 Queue 行

6. **推播通知**（使用確認機制）：⭐ 新增
   - 在 Queue 填寫追蹤碼
   - 選擇物流公司（Courier 欄位）
   - 勾選 ReadyToNotify = TRUE
   - 或使用「通知管理」介面預覽後確認發送
   - 系統推播 LINE 給客戶

7. **揀貨作業**：
   - 商品抵台後，使用「揀貨視圖」
   - 依箱號查看需要揀貨的商品

### 2. 日常使用建議

- 每天檢查「通知紀錄查詢」，確認推播狀態
- 定期備份 Google Sheets（檔案 → 建立副本）
- 善用「訂單比對 v2」處理到貨分配

---

## 🎉 恭喜！系統安裝完成

您現在擁有一個完整的採購控制與倉儲物流管理系統！

**系統特色**：
- 🚀 全自動化 LINE 通知
- 🔔 **推播確認機制**（避免誤發）⭐ 新增
- 📦 **物流公司選擇**（順豐/Score）⭐ 新增
- 📊 智能採購彙總與折扣分攤
- 📦 完整的批次與箱號管理
- ✅ 台灣端揀貨支援
- 🔍 強大的訂單比對工具

如有任何問題，請檢查：
1. Apps Script 執行記錄
2. NotificationsLog 錯誤訊息
3. Script Properties 設定
4. **推播確認機制說明.md**（新增）⭐
5. **物流公司選擇功能說明.md**（新增）⭐

祝您使用愉快！🎊
