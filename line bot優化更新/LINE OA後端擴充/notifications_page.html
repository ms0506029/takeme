<!-- ==========================================
     é€šçŸ¥ç®¡ç†é é¢å…§å®¹
     ç”¨æ–¼æ›¿æ› LINE OA å¾Œç«¯ HTML ä¸­çš„ notificationsContent
     ========================================== -->

<div id="notificationsContent" class="page-content" style="display: none;">
    <!-- æ¨™ç±¤é  -->
    <ul class="nav nav-tabs mb-3" id="notifyTabs">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#oosPanel">
                <i class="fas fa-exclamation-triangle me-2"></i>âš ï¸ ç¼ºè²¨å¾…é€šçŸ¥
                <span class="badge bg-danger ms-2" id="oosBadge">0</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#shippingPanel">
                <i class="fas fa-shipping-fast me-2"></i>ğŸ“¦ ç‰©æµå¾…ç™¼é€
                <span class="badge bg-primary ms-2" id="shippingBadge">0</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#historyPanel">
                <i class="fas fa-history me-2"></i>ğŸ“‹ ç™¼é€ç´€éŒ„
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- ç¼ºè²¨é€šçŸ¥é¢æ¿ -->
        <div class="tab-pane fade show active" id="oosPanel">
            <div class="content-card">
                <div class="content-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>å¾…ç™¼é€ç¼ºè²¨é€šçŸ¥</h5>
                    <button class="btn btn-light btn-sm" onclick="loadPendingOOS()">
                        <i class="fas fa-sync-alt me-1"></i>é‡æ–°æ•´ç†
                    </button>
                </div>
                <div class="content-body">
                    <!-- æ‰¹é‡æ“ä½œ -->
                    <div class="bulk-actions mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllOOS" onchange="toggleSelectAllOOS()">
                                <label class="form-check-label" for="selectAllOOS">å…¨é¸</label>
                            </div>
                            <div>
                                <button class="btn btn-warning btn-sm" onclick="previewOOSNotification()">
                                    <i class="fas fa-eye me-1"></i>é è¦½
                                </button>
                                <button class="btn btn-danger btn-sm ms-2" onclick="sendSelectedOOS()">
                                    <i class="fas fa-paper-plane me-1"></i>ç™¼é€æ‰€é¸
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç¼ºè²¨å•†å“è¡¨æ ¼ -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="oosTable">
                            <thead class="table-dark">
                                <tr>
                                    <th width="50px">é¸æ“‡</th>
                                    <th>å•†å“åç¨±</th>
                                    <th>è¨‚å–®ç·¨è™Ÿ</th>
                                    <th>é¡§å®¢</th>
                                    <th>LINE ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="oosTableBody">
                                <tr><td colspan="6" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç‰©æµé€šçŸ¥é¢æ¿ -->
        <div class="tab-pane fade" id="shippingPanel">
            <div class="content-card">
                <div class="content-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>å¾…ç™¼é€ç‰©æµé€šçŸ¥</h5>
                    <button class="btn btn-light btn-sm" onclick="loadPendingShipping()">
                        <i class="fas fa-sync-alt me-1"></i>é‡æ–°æ•´ç†
                    </button>
                </div>
                <div class="content-body">
                    <!-- æ‰¹é‡æ“ä½œ -->
                    <div class="bulk-actions mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllShipping" onchange="toggleSelectAllShipping()">
                                <label class="form-check-label" for="selectAllShipping">å…¨é¸</label>
                            </div>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="sendSelectedShipping()">
                                    <i class="fas fa-paper-plane me-1"></i>ç™¼é€æ‰€é¸
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç‰©æµå•†å“è¡¨æ ¼ -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="shippingTable">
                            <thead class="table-dark">
                                <tr>
                                    <th width="50px">é¸æ“‡</th>
                                    <th>å•†å“åç¨±</th>
                                    <th>è¨‚å–®ç·¨è™Ÿ</th>
                                    <th>ç®±è™Ÿ</th>
                                    <th>è¿½è¹¤è™Ÿç¢¼</th>
                                    <th>é¡§å®¢</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="shippingTableBody">
                                <tr><td colspan="7" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç™¼é€ç´€éŒ„é¢æ¿ -->
        <div class="tab-pane fade" id="historyPanel">
            <div class="content-card">
                <div class="content-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>é€šçŸ¥ç™¼é€ç´€éŒ„</h5>
                </div>
                <div class="content-body">
                    <p class="text-muted">åŠŸèƒ½é–‹ç™¼ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é è¦½ Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-eye me-2"></i>è¨Šæ¯é è¦½</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent" class="p-3 bg-light rounded">
                    <!-- é è¦½å…§å®¹ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="confirmSendOOS()">
                    <i class="fas fa-paper-plane me-1"></i>ç¢ºèªç™¼é€
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// é€šçŸ¥ç®¡ç† JavaScript
// ==========================================

const API_BASE = 'YOUR_API_URL'; // æ›¿æ›ç‚ºå¯¦éš› API URL

let pendingOOSItems = [];
let pendingShippingItems = [];
let selectedOOSIds = new Set();
let selectedShippingIds = new Set();

// è¼‰å…¥ç¼ºè²¨å¾…é€šçŸ¥åˆ—è¡¨
async function loadPendingOOS() {
    try {
        document.getElementById('oosTableBody').innerHTML = 
            '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> è¼‰å…¥ä¸­...</td></tr>';
        
        const response = await fetch(`${API_BASE}?action=getPendingOOSNotifications`);
        const result = await response.json();
        
        if (result.success) {
            pendingOOSItems = result.items;
            renderOOSTable();
            document.getElementById('oosBadge').textContent = result.items.length;
        } else {
            showToast('è¼‰å…¥å¤±æ•—: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('è¼‰å…¥ç¼ºè²¨åˆ—è¡¨å¤±æ•—:', error);
        showToast('è¼‰å…¥å¤±æ•—', 'error');
    }
}

// æ¸²æŸ“ç¼ºè²¨è¡¨æ ¼
function renderOOSTable() {
    const tbody = document.getElementById('oosTableBody');
    
    if (pendingOOSItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">âœ… ç›®å‰æ²’æœ‰å¾…ç™¼é€çš„ç¼ºè²¨é€šçŸ¥</td></tr>';
        return;
    }
    
    tbody.innerHTML = pendingOOSItems.map(item => `
        <tr>
            <td>
                <input type="checkbox" class="form-check-input oos-checkbox" 
                       value="${item.queueId}" 
                       ${item.canSend ? '' : 'disabled'}
                       onchange="updateOOSSelection(this)">
            </td>
            <td>
                <strong>${item.productName}</strong>
                ${item.color || item.size ? `<br><small class="text-muted">${[item.color, item.size].filter(Boolean).join(' / ')}</small>` : ''}
            </td>
            <td><code>${item.esOrderNo}</code></td>
            <td>${item.customerName || '-'}</td>
            <td>
                ${item.canSend 
                    ? '<span class="badge bg-success">å·²ç¶å®š</span>' 
                    : '<span class="badge bg-secondary">æœªç¶å®š</span>'}
            </td>
            <td>
                ${item.canSend 
                    ? `<button class="btn btn-sm btn-outline-danger" onclick="sendSingleOOS('${item.queueId}')">
                         <i class="fas fa-paper-plane"></i>
                       </button>` 
                    : '-'}
            </td>
        </tr>
    `).join('');
}

// è¼‰å…¥ç‰©æµå¾…ç™¼é€åˆ—è¡¨
async function loadPendingShipping() {
    try {
        document.getElementById('shippingTableBody').innerHTML = 
            '<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm"></div> è¼‰å…¥ä¸­...</td></tr>';
        
        const response = await fetch(`${API_BASE}?action=getPendingShippingNotifications`);
        const result = await response.json();
        
        if (result.success) {
            pendingShippingItems = result.items;
            renderShippingTable();
            document.getElementById('shippingBadge').textContent = result.items.length;
        } else {
            showToast('è¼‰å…¥å¤±æ•—: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('è¼‰å…¥ç‰©æµåˆ—è¡¨å¤±æ•—:', error);
        showToast('è¼‰å…¥å¤±æ•—', 'error');
    }
}

// æ¸²æŸ“ç‰©æµè¡¨æ ¼
function renderShippingTable() {
    const tbody = document.getElementById('shippingTableBody');
    
    if (pendingShippingItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">âœ… ç›®å‰æ²’æœ‰å¾…ç™¼é€çš„ç‰©æµé€šçŸ¥</td></tr>';
        return;
    }
    
    tbody.innerHTML = pendingShippingItems.map(item => `
        <tr>
            <td>
                <input type="checkbox" class="form-check-input shipping-checkbox" 
                       value="${item.queueId}" 
                       ${item.canSend ? '' : 'disabled'}
                       onchange="updateShippingSelection(this)">
            </td>
            <td><strong>${item.productName}</strong></td>
            <td><code>${item.esOrderNo}</code></td>
            <td><span class="badge bg-info">${item.boxId}</span></td>
            <td>${item.trackingJPtoTW || '-'}</td>
            <td>${item.customerName || '-'}</td>
            <td>
                ${item.canSend 
                    ? `<button class="btn btn-sm btn-outline-primary" onclick="sendSingleShipping('${item.queueId}')">
                         <i class="fas fa-paper-plane"></i>
                       </button>` 
                    : '-'}
            </td>
        </tr>
    `).join('');
}

// å…¨é¸ç¼ºè²¨
function toggleSelectAllOOS() {
    const checked = document.getElementById('selectAllOOS').checked;
    document.querySelectorAll('.oos-checkbox:not(:disabled)').forEach(cb => {
        cb.checked = checked;
        if (checked) {
            selectedOOSIds.add(cb.value);
        } else {
            selectedOOSIds.delete(cb.value);
        }
    });
}

// å…¨é¸ç‰©æµ
function toggleSelectAllShipping() {
    const checked = document.getElementById('selectAllShipping').checked;
    document.querySelectorAll('.shipping-checkbox:not(:disabled)').forEach(cb => {
        cb.checked = checked;
        if (checked) {
            selectedShippingIds.add(cb.value);
        } else {
            selectedShippingIds.delete(cb.value);
        }
    });
}

// æ›´æ–°ç¼ºè²¨é¸æ“‡
function updateOOSSelection(checkbox) {
    if (checkbox.checked) {
        selectedOOSIds.add(checkbox.value);
    } else {
        selectedOOSIds.delete(checkbox.value);
    }
}

// æ›´æ–°ç‰©æµé¸æ“‡
function updateShippingSelection(checkbox) {
    if (checkbox.checked) {
        selectedShippingIds.add(checkbox.value);
    } else {
        selectedShippingIds.delete(checkbox.value);
    }
}

// é è¦½ç¼ºè²¨é€šçŸ¥
function previewOOSNotification() {
    if (selectedOOSIds.size === 0) {
        showToast('è«‹å…ˆé¸æ“‡è¦ç™¼é€çš„å•†å“', 'warning');
        return;
    }
    
    const selectedItems = pendingOOSItems.filter(i => selectedOOSIds.has(i.queueId));
    
    let previewHtml = '<div class="flex-preview">';
    previewHtml += '<div class="preview-header bg-warning text-dark p-2 rounded-top"><strong>âš ï¸ å•†å“ç¼ºè²¨é€šçŸ¥</strong></div>';
    previewHtml += '<div class="preview-body p-3">';
    selectedItems.forEach(item => {
        previewHtml += `<p><strong>${item.productName}</strong><br><small>è¨‚å–®ï¼š${item.esOrderNo}</small></p>`;
    });
    previewHtml += '<p>å¾ˆæŠ±æ­‰ï¼Œæ‚¨è¨‚è³¼çš„å•†å“ç›®å‰æš«æ™‚ç¼ºè²¨ã€‚<br>è«‹å•æ‚¨é¡˜æ„ç­‰å¾…è£œè²¨å—ï¼Ÿé è¨ˆéœ€è¦ 2-4 å¤©ã€‚</p>';
    previewHtml += '</div>';
    previewHtml += '<div class="preview-footer p-2">';
    previewHtml += '<button class="btn btn-success btn-sm w-100 mb-2">ğŸŸ¢ é¡˜æ„ç­‰å¾…ï¼ˆ2-4å¤©ï¼‰</button>';
    previewHtml += '<button class="btn btn-outline-secondary btn-sm w-100">ğŸ”´ ä¸é¡˜ç­‰å¾…ï¼ˆç”³è«‹é€€æ¬¾ï¼‰</button>';
    previewHtml += '</div></div>';
    
    document.getElementById('previewContent').innerHTML = previewHtml;
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

// ç¢ºèªç™¼é€ç¼ºè²¨é€šçŸ¥
async function confirmSendOOS() {
    bootstrap.Modal.getInstance(document.getElementById('previewModal')).hide();
    await sendSelectedOOS();
}

// ç™¼é€é¸ä¸­çš„ç¼ºè²¨é€šçŸ¥
async function sendSelectedOOS() {
    if (selectedOOSIds.size === 0) {
        showToast('è«‹å…ˆé¸æ“‡è¦ç™¼é€çš„å•†å“', 'warning');
        return;
    }
    
    const selectedItems = pendingOOSItems.filter(i => selectedOOSIds.has(i.queueId));
    let successCount = 0;
    
    for (const item of selectedItems) {
        try {
            const params = new URLSearchParams({
                action: 'sendOOSNotification',
                queueId: item.queueId,
                lineUserId: item.lineUserId,
                productName: item.productName,
                esOrderNo: item.esOrderNo,
                color: item.color || '',
                size: item.size || ''
            });
            
            const response = await fetch(`${API_BASE}?${params}`);
            const result = await response.json();
            
            if (result.success) {
                successCount++;
            }
        } catch (error) {
            console.error('ç™¼é€å¤±æ•—:', item.queueId, error);
        }
    }
    
    showToast(`å·²ç™¼é€ ${successCount}/${selectedItems.length} ç­†é€šçŸ¥`, successCount > 0 ? 'success' : 'error');
    selectedOOSIds.clear();
    loadPendingOOS();
}

// ç™¼é€å–®ç­†ç¼ºè²¨é€šçŸ¥
async function sendSingleOOS(queueId) {
    const item = pendingOOSItems.find(i => i.queueId === queueId);
    if (!item) return;
    
    if (!confirm(`ç¢ºå®šè¦ç™¼é€ç¼ºè²¨é€šçŸ¥çµ¦ã€Œ${item.customerName}ã€å—ï¼Ÿ`)) return;
    
    try {
        const params = new URLSearchParams({
            action: 'sendOOSNotification',
            queueId: item.queueId,
            lineUserId: item.lineUserId,
            productName: item.productName,
            esOrderNo: item.esOrderNo,
            color: item.color || '',
            size: item.size || ''
        });
        
        const response = await fetch(`${API_BASE}?${params}`);
        const result = await response.json();
        
        if (result.success) {
            showToast('é€šçŸ¥å·²ç™¼é€', 'success');
            loadPendingOOS();
        } else {
            showToast('ç™¼é€å¤±æ•—: ' + result.error, 'error');
        }
    } catch (error) {
        showToast('ç™¼é€å¤±æ•—', 'error');
    }
}

// ç™¼é€é¸ä¸­çš„ç‰©æµé€šçŸ¥
async function sendSelectedShipping() {
    if (selectedShippingIds.size === 0) {
        showToast('è«‹å…ˆé¸æ“‡è¦ç™¼é€çš„å•†å“', 'warning');
        return;
    }
    
    const selectedItems = pendingShippingItems.filter(i => selectedShippingIds.has(i.queueId));
    let successCount = 0;
    
    for (const item of selectedItems) {
        try {
            const params = new URLSearchParams({
                action: 'sendShippingNotification',
                queueId: item.queueId,
                lineUserId: item.lineUserId,
                productName: item.productName,
                esOrderNo: item.esOrderNo,
                boxId: item.boxId,
                trackingNo: item.trackingJPtoTW || ''
            });
            
            const response = await fetch(`${API_BASE}?${params}`);
            const result = await response.json();
            
            if (result.success) {
                successCount++;
            }
        } catch (error) {
            console.error('ç™¼é€å¤±æ•—:', item.queueId, error);
        }
    }
    
    showToast(`å·²ç™¼é€ ${successCount}/${selectedItems.length} ç­†é€šçŸ¥`, successCount > 0 ? 'success' : 'error');
    selectedShippingIds.clear();
    loadPendingShipping();
}

// ç™¼é€å–®ç­†ç‰©æµé€šçŸ¥
async function sendSingleShipping(queueId) {
    const item = pendingShippingItems.find(i => i.queueId === queueId);
    if (!item) return;
    
    if (!confirm(`ç¢ºå®šè¦ç™¼é€ç‰©æµé€šçŸ¥çµ¦ã€Œ${item.customerName}ã€å—ï¼Ÿ`)) return;
    
    try {
        const params = new URLSearchParams({
            action: 'sendShippingNotification',
            queueId: item.queueId,
            lineUserId: item.lineUserId,
            productName: item.productName,
            esOrderNo: item.esOrderNo,
            boxId: item.boxId,
            trackingNo: item.trackingJPtoTW || ''
        });
        
        const response = await fetch(`${API_BASE}?${params}`);
        const result = await response.json();
        
        if (result.success) {
            showToast('é€šçŸ¥å·²ç™¼é€', 'success');
            loadPendingShipping();
        } else {
            showToast('ç™¼é€å¤±æ•—: ' + result.error, 'error');
        }
    } catch (error) {
        showToast('ç™¼é€å¤±æ•—', 'error');
    }
}

// åˆå§‹åŒ–ï¼šåˆ‡æ›åˆ°é€šçŸ¥ç®¡ç†æ™‚è¼‰å…¥è³‡æ–™
document.querySelector('[data-page="notifications"]').addEventListener('click', function() {
    loadPendingOOS();
    loadPendingShipping();
});
</script>
